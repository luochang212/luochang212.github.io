{"version":2,"kind":"Notebook","sha256":"c456f03a271ec93874d600eb3ff0262bb72015fd014d48eab0093fc500826aa0","slug":"stategraph","location":"/2.stategraph.ipynb","dependencies":[],"frontmatter":{"title":"StateGraph","content_includes_title":false,"kernelspec":{"name":"py313","display_name":"Python (py3.13)","language":"python"},"github":"https://github.com/luochang212/langgraph-tutorial","keywords":["LangGraph","Langchain"],"source_url":"https://github.com/luochang212/langgraph-tutorial/blob/main/2.stategraph.ipynb","edit_url":"https://github.com/luochang212/langgraph-tutorial/edit/main/2.stategraph.ipynb","exports":[{"format":"ipynb","filename":"2.stategraph.ipynb","url":"/2.stategraph-b8f4cd5bd5b1dd58d535d93a4a07b97e.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"blockquote","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"使用 ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"eTJTZDuiBo"},{"type":"inlineCode","value":"StateGraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Ow4RIBdz3t"},{"type":"text","value":" 构建有向循环图","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"BHVg5iRBdv"}],"key":"fzcSsclgWB"}],"key":"X5fiITTdlt"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"上一节，我们演示了如何使用 LangGraph 创建 Agent。然而，使用 Agent 调用 LLM 终究是隔了一层。我们将工具调用、流程控制的权力交给 Agent 的同时，也失去了对具体行为的掌控。","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"UUtmEkfLoh"}],"key":"fCgqlFQ9Xp"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"现在我们回到 LangGraph 底层，使用 ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"s8BG6k5MEf"},{"type":"inlineCode","value":"StateGraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"jAUuV890TF"},{"type":"text","value":" 直接控制代码执行。","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"EgLeiCpToi"}],"key":"Hsa91RhSov"}],"key":"Jr2l1jwIuz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nfrom dotenv import load_dotenv\nfrom langchain_openai import ChatOpenAI\nfrom langgraph.graph import StateGraph, MessagesState, START, END\nfrom langchain_core.messages import SystemMessage, HumanMessage\nfrom langchain_core.tools import tool\nfrom langgraph.prebuilt import ToolNode\nfrom langchain_core.runnables import RunnableConfig\n\n# 加载模型配置\n_ = load_dotenv()","key":"bkKh95nRkr"},{"type":"output","id":"QsiaPUAK1LN2G6GFbu2rV","data":[],"key":"NZ1tesar2t"}],"key":"jT8LqdGGuQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 加载模型\nllm = ChatOpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n    model=\"qwen3-coder-plus\",\n    temperature=0.7,\n)\n\n# 工具函数\n@tool\ndef get_weather(city: str) -> str:\n    \"\"\"Get weather for a given city.\"\"\"\n    return f\"It's always sunny in {city}!\"\n\n# 创建工具节点\ntools = [get_weather]\ntool_node = ToolNode(tools)\n\n# 创建助手节点\ndef assistant(state: MessagesState, config: RunnableConfig):\n    system_prompt = 'You are a helpful assistant that can check weather.'\n    all_messages = [SystemMessage(system_prompt)] + state['messages']\n    model = llm.bind_tools(tools)\n    return {'messages': [model.invoke(all_messages)]}\n\n# 创建条件边\ndef should_continue(state: MessagesState, config: RunnableConfig):\n    messages = state['messages']\n    last_message = messages[-1]\n    if last_message.tool_calls:\n        return 'continue'\n    return 'end'","key":"UaUp5SH0Q3"},{"type":"output","id":"juddoCL9HuFEeIiPAFPKl","data":[],"key":"CseShaDtqi"}],"key":"XKtOAzysfP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 创建图\nbuilder = StateGraph(MessagesState)\n\n# 添加节点\nbuilder.add_node('assistant', assistant)\nbuilder.add_node('tool', tool_node)\n\n# 添加边\nbuilder.add_edge(START, 'assistant')\n\n# 添加条件边\nbuilder.add_conditional_edges(\n    'assistant',\n    should_continue,\n    {\n        'continue': 'tool',\n        'end': END,\n    },\n)\n\n# 添加边：调用工具节点后回到assistant\nbuilder.add_edge('tool', 'assistant')\n\n# 编译图\nmy_graph = builder.compile(name='my-graph')\nmy_graph","key":"YWWymZaPhQ"},{"type":"output","id":"yFxZhyaferRSNEPnc9Al1","data":[{"output_type":"execute_result","execution_count":3,"metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"0d346dd92e27fac0c71b9070350384ea","path":"/0d346dd92e27fac0c71b9070350384ea.png"},"text/plain":{"content":"<langgraph.graph.state.CompiledStateGraph object at 0x1114a4050>","content_type":"text/plain"}}}],"key":"o7DIIF5Cmm"}],"key":"FJEo7Mszsf"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"有向图分为：","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Z2j0kRled1"}],"key":"th7o1qYqZ4"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"有向无环图（DAG）","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"J3iQCtvKaA"}],"key":"LHvnUXYTjk"}],"key":"UfH3lRVsYS"},{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"有向循环图（DCG）","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"xf537mwAhQ"}],"key":"HG5WIR4YXx"}],"key":"NI3lt9wfX1"}],"key":"OucptoB5oj"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"从上图可以看出，我们使用 StateGraph 创建的是一个有向循环图。","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"j36maBk0HU"}],"key":"TYy9rFq1mW"}],"key":"y569bgYTuv"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 调用图\nresponse = my_graph.invoke({'messages': [HumanMessage(content='上海天气怎么样？')]})\nfor message in response['messages']:\n    message.pretty_print()","key":"ciT2r0eU9n"},{"type":"output","id":"DK7o_f_2LJlrwfAJsbpt9","data":[{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\n上海天气怎么样？\n==================================\u001b[1m Ai Message \u001b[0m==================================\nTool Calls:\n  get_weather (call_e4a04b30a035493985be60c7)\n Call ID: call_e4a04b30a035493985be60c7\n  Args:\n    city: 上海\n=================================\u001b[1m Tool Message \u001b[0m=================================\nName: get_weather\n\nIt's always sunny in 上海!\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\n上海的天气总是晴朗明媚！☀️ 如果你想了解更具体的天气信息，比如温度或降水概率，可以告诉我哦！\n"}],"key":"pfSReMGROw"}],"key":"s1CSNk5P05"}],"key":"ikLP0iHMXA"},"references":{"cite":{"order":[],"data":{}}}}