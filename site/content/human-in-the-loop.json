{"version":2,"kind":"Notebook","sha256":"d94856b83ea5823ad3e9938663115f04ced6d31974ea0b7f850245f563cd0559","slug":"human-in-the-loop","location":"/4.human_in_the_loop.ipynb","dependencies":[],"frontmatter":{"title":"人机交互","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"github":"https://github.com/luochang212/langgraph-tutorial","keywords":["LangGraph","Langchain"],"source_url":"https://github.com/luochang212/langgraph-tutorial/blob/main/4.human_in_the_loop.ipynb","edit_url":"https://github.com/luochang212/langgraph-tutorial/edit/main/4.human_in_the_loop.ipynb","exports":[{"format":"ipynb","filename":"4.human_in_the_loop.ipynb","url":"/4.human_in_the_loop-0095e5b35970d9d1033a6d1ca111d6f3.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"人机交互（Human-in-the-loop, HITL）中间件用于在智能体执行过程中加入人工审批。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"VUIaUjK0yw"}],"key":"d4fE1RIYCa"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"当触发人工审批时，HITL 中间件会","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"rpdXNdLMWL"},{"type":"link","url":"https://reference.langchain.com/python/langgraph/types/#langgraph.types.interrupt","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"中断","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"d4vQEqxKAO"}],"urlSource":"https://reference.langchain.com/python/langgraph/types/#langgraph.types.interrupt","key":"Qf64nvfSnk"},{"type":"text","value":"程序执行。此时，LangGraph 的状态保存在 ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"pzzwGa75KU"},{"type":"link","url":"https://docs.langchain.com/oss/javascript/langgraph/persistence#checkpointer-libraries","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"checkpointer","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Qx5NiMRy2v"}],"urlSource":"https://docs.langchain.com/oss/javascript/langgraph/persistence#checkpointer-libraries","key":"fSyjTqEjLF"},{"type":"text","value":" 中，因此程序可以安全地暂停，并在人工审批之后恢复。","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"rKoNTOIQix"}],"key":"lry91utLVE"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"本文只是演示 checkpoint 在人机交互中的作用，无所谓线程结束后记忆是否保持，因此使用最方便的 ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"JO3ipIiY7d"},{"type":"inlineCode","value":"InMemorySaver","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"E3XmdG3Pch"},{"type":"text","value":"。在生产环节中，推荐使用由数据库支持的检查点，比如：","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"xY5sCRUiet"}],"key":"Ffnco95BMj"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":9,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"SqliteSaver","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"SDSpJCcU6g"}],"key":"dz4x5HXfTE"}],"key":"eh85C9uj3N"},{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"PostgresSaver","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"mxnFxtAtGW"}],"key":"xwlLUwcNW3"}],"key":"fXEmtRhZSY"},{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"MongoDBSaver","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"x95yi6NNB7"}],"key":"zVLHm6B7TT"}],"key":"DEzAxx7HG3"},{"type":"listItem","spread":true,"position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"RedisSaver","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"VkreHepsC5"}],"key":"Ey4kvLXNTH"}],"key":"NCfUlcm7T0"}],"key":"MjXmQaYuFD"}],"key":"qjHsAbpfIt"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nimport uuid\nfrom dotenv import load_dotenv\nfrom langchain_openai import ChatOpenAI\nfrom langchain.agents import create_agent\nfrom langchain.agents.middleware import HumanInTheLoopMiddleware\nfrom langchain_core.tools import tool\nfrom langgraph.checkpoint.memory import InMemorySaver\nfrom langgraph.types import Command\n\n# 加载模型配置\n_ = load_dotenv()","key":"AjwUOgNs81"},{"type":"output","id":"5EZI3-XVfWcWGEL3xJbVC","data":[],"key":"gODXk6volY"}],"key":"nmvm9e1MCI"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 配置大模型服务\nllm = ChatOpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n    model=\"qwen3-coder-plus\",\n)\n\n# 工具函数\n@tool\ndef get_weather(city: str) -> str:\n    \"\"\"Get weather for a given city.\"\"\"\n    return f\"It's always sunny in {city}!\"\n\n@tool\ndef add_numbers(a: float, b: float) -> float:\n    \"\"\"Add two numbers and return the sum.\"\"\"\n    return a + b\n\n@tool\ndef calculate_bmi(weight_kg: float, height_m: float) -> float:\n    \"\"\"Calculate BMI given weight in kg and height in meters.\"\"\"\n    if height_m <= 0 or weight_kg <= 0:\n        raise ValueError(\"height_m and weight_kg must be greater than 0.\")\n    return weight_kg / (height_m ** 2)\n\n# 创建带工具调用的Agent\ntool_agent = create_agent(\n    model=llm,\n    tools=[get_weather, add_numbers, calculate_bmi],\n    middleware=[\n        HumanInTheLoopMiddleware( \n            interrupt_on={\n                # 无需触发人工审批\n                \"get_weather\": False,\n                # 需要审批，且允许approve,edit,reject三种审批类型\n                \"add_numbers\": True,\n                # 需要审批，允许approve,reject两种审批类型\n                \"calculate_bmi\": {\"allowed_decisions\": [\"approve\", \"reject\"]},\n            },\n            description_prefix=\"Tool execution pending approval\",\n        ),\n    ],\n    checkpointer=InMemorySaver(),\n    system_prompt=\"You are a helpful assistant\",\n)","key":"oAPxJ0X1Pj"},{"type":"output","id":"eGkEPnbemMYV8GFHRaoui","data":[],"key":"wAoE0FgVlr"}],"key":"jTyqWco1ZK"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 运行Agent\nconfig = {'configurable': {'thread_id': str(uuid.uuid4())}}\nresult = tool_agent.invoke(\n    {\"messages\": [{\n        \"role\": \"user\",\n        \"content\": \"我身高180cm，体重180斤，我的BMI是多少\"\n        # \"content\": \"what is the weather in sf\"\n    }]},\n    config=config,\n)\n\n# result['messages'][-1].content\nresult.get('__interrupt__')","key":"kNsUVBQZ8k"},{"type":"output","id":"iuDWj3nMujaJCfBiY-lhe","data":[{"output_type":"execute_result","execution_count":3,"metadata":{},"data":{"text/plain":{"content":"[Interrupt(value={'action_requests': [{'name': 'calculate_bmi', 'args': {'height_m': 1.8, 'weight_kg': 90}, 'description': \"Tool execution pending approval\\n\\nTool: calculate_bmi\\nArgs: {'height_m': 1.8, 'weight_kg': 90}\"}], 'review_configs': [{'action_name': 'calculate_bmi', 'allowed_decisions': ['approve', 'reject']}]}, id='b58dbd2802c1ff4f89a7504b20d5d229')]","content_type":"text/plain"}}}],"key":"GVeNrYZo4O"}],"key":"d6dhKgeXIb"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Resume with approval decision\nresult = tool_agent.invoke(\n    Command(\n        resume={\"decisions\": [{\"type\": \"approve\"}]}  # or \"edit\", \"reject\"\n    ), \n    config=config\n)\n\nresult['messages'][-1].content","key":"xyHr86Igva"},{"type":"output","id":"tGmLi9WwL3YxjkrO_ciNx","data":[{"output_type":"execute_result","execution_count":4,"metadata":{},"data":{"text/plain":{"content":"'您的BMI是27.8。根据中国成人BMI标准，这属于超重范围（BMI ≥ 24为超重，≥ 28为肥胖）。建议您关注饮食健康和适量运动，如有需要可咨询医生或营养师以获得更专业的建议。'","content_type":"text/plain"}}}],"key":"ABlGnLkPml"}],"key":"HMKEHMmDTT"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"参考文档：","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"wWujXVckeS"}],"key":"THwzXaJL5T"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":3,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"paragraph","children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langchain/human-in-the-loop","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"langchain​/human​-in​-the​-loop","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Z3J5ayrAsB"}],"urlSource":"https://docs.langchain.com/oss/python/langchain/human-in-the-loop","key":"Sc1nRiqURx"}],"key":"wueKxS4Y3s"}],"key":"zJ7whZIW8a"},{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langchain/short-term-memory","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"langchain​/short​-term​-memory","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"vSZ9gdN9he"}],"urlSource":"https://docs.langchain.com/oss/python/langchain/short-term-memory","key":"RVODjaBJKo"}],"key":"oqivRQsNAz"}],"key":"QgB9wX6suz"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langchain/long-term-memory","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"langchain​/long​-term​-memory","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"saPNhghq3I"}],"urlSource":"https://docs.langchain.com/oss/python/langchain/long-term-memory","key":"nAN3NMIxm4"}],"key":"tAJPs7Nt5i"}],"key":"tRyWqNp771"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langgraph/persistence","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"langgraph​/persistence","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"Uw4SniyMbr"}],"urlSource":"https://docs.langchain.com/oss/python/langgraph/persistence","key":"gZZCaWBzov"}],"key":"gchCOus0rK"}],"key":"z0aV2piKTx"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langgraph/use-time-travel","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"langgraph​/use​-time​-travel","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"PakdeVqT6z"}],"urlSource":"https://docs.langchain.com/oss/python/langgraph/use-time-travel","key":"XEvSa1Ttjf"}],"key":"rilyePa5ga"}],"key":"CIiB3JglrA"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langgraph/add-memory","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"langgraph​/add​-memory","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"MYp0z02oEh"}],"urlSource":"https://docs.langchain.com/oss/python/langgraph/add-memory","key":"FtdBqScvKf"}],"key":"HfhGxTKDB8"}],"key":"uNZ0cKQyMY"}],"key":"f99qQPzNoz"}],"key":"ii44X2hgMo"}],"key":"wlVLmyAsia"},"references":{"cite":{"order":[],"data":{}}}}