{"version":2,"kind":"Notebook","sha256":"7cde428d9daaec6e69ea6f42880268ede398215fe57024ff2e6ec1fb90eb3570","slug":"mcp-server","location":"/7.mcp_server.ipynb","dependencies":[],"frontmatter":{"title":"MCP Server","content_includes_title":false,"kernelspec":{"name":"py313","display_name":"Python (py3.13)","language":"python"},"github":"https://github.com/luochang212/langgraph-tutorial","keywords":["LangGraph","Langchain"],"source_url":"https://github.com/luochang212/langgraph-tutorial/blob/main/7.mcp_server.ipynb","edit_url":"https://github.com/luochang212/langgraph-tutorial/edit/main/7.mcp_server.ipynb","exports":[{"format":"ipynb","filename":"7.mcp_server.ipynb","url":"/7.mcp_server-71f35c6fadb295b2af1c2aeeb8a66b8e.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"这一节，我们在 LangGraph 中接入 MCP Server。要接入 MCP Server，首先得先有 MCP Server。哦这可是我的老本行！我在纸牌魔术MCP（","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"CDM5jHTzeB"},{"type":"link","url":"https://github.com/luochang212/card-magic-mcp","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"card-magic-mcp","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"CKwHdA6OWb"}],"urlSource":"https://github.com/luochang212/card-magic-mcp","error":true,"key":"LmUjRabdOV"},{"type":"text","value":"）中已经总结出一套高效的写法了。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"eTTXwrbFb9"}],"key":"lj0B1sLiw1"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"相关代码在本仓库的 ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"ZhNboJATPZ"},{"type":"link","url":"/READMD-bdd2639de7b5cbc297370c4ce48c11e4.md","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"mcp_server","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"lfTwX9ZAJy"}],"urlSource":"./mcp_server/READMD.md","static":true,"protocol":"file","key":"vLZk5O63Qr"},{"type":"text","value":" 路径下。","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"NF7VnGtWp9"}],"key":"werGCe72du"},{"type":"heading","depth":2,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"一、开发 MCP 服务","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"uBDU2zN6O6"}],"identifier":"id-mcp","label":"一、开发 MCP 服务","html_id":"id-mcp","implicit":true,"key":"QkGv186Fmz"},{"type":"heading","depth":3,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"1）天气 MCP","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"iUMsXnfER4"}],"identifier":"id-1-mcp","label":"1）天气 MCP","html_id":"id-1-mcp","implicit":true,"key":"hlNatxAfz1"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"以 ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"bVx5vqfcLY"},{"type":"inlineCode","value":"get_weather_mcp","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"J4m0LtVvXB"},{"type":"text","value":" 为例，我们要把这个 MCP 写成一个 Python 包。当然仅供本地使用，如果你想传到 PyPI 上当然可以，但那就是另外的流程了，敬请参考我的博客 ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"S5aaJlYvg7"},{"type":"link","url":"https://luochang212.github.io/posts/pypi_packaging/","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"《PyPI 打包小记》","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"CYiugtsfxI"}],"urlSource":"https://luochang212.github.io/posts/pypi_packaging/","key":"YiNp7RJZUm"},{"type":"text","value":"。","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"QiYCjPipUT"}],"key":"mpz3e22Ljt"},{"type":"paragraph","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"为了让它被识别为 Python 包，我们要在项目下，新建一个 ","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"gy9KKQqkl1"},{"type":"inlineCode","value":"__init__.py","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"G3pqEQQOpb"},{"type":"text","value":" 文件。然后把主逻辑写在 ","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"qtzIXzSSel"},{"type":"inlineCode","value":"server.py","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"s1zgtCZR6o"},{"type":"text","value":" 中，接着在 ","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"FZBB5mP90U"},{"type":"inlineCode","value":"__main__.py","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"TLtPzwKNtI"},{"type":"text","value":" 中使用 ","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"dTKVJ1ACHE"},{"type":"inlineCode","value":"from . import server","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"yAX45CL5QZ"},{"type":"text","value":" 引入它。最后用 streamable-http 的方式部署它：","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"gCRf2mo22Q"}],"key":"b9Ne557pQR"},{"type":"code","lang":"python","value":"def http():\n    \"\"\"streamable-http entry point for the package.\"\"\"\n    asyncio.run(server.mcp.run(transport=\"http\",\n                               host=host,\n                               port=port,\n                               path=\"/mcp\"))","position":{"start":{"line":15,"column":1},"end":{"line":22,"column":1}},"key":"Y6OuW1VxEB"},{"type":"paragraph","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"text","value":"写到这里就齐活了。这里使用 ","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"fSBxToflqA"},{"type":"inlineCode","value":"__main__.py","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"BQMb77OG4a"},{"type":"text","value":" 是有小巧思的，这样我们可以将这个包作为模块直接在命令行使用。什么意思呢？就是我们用 ","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"gmMERQeiRH"},{"type":"inlineCode","value":"python -m [包名]","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"eRVMNBAvYY"},{"type":"text","value":" 就等于直接运行了 ","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"LBqftmxxvn"},{"type":"inlineCode","value":"__main__.py","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"mcFtH4oMm4"},{"type":"text","value":" 这个特殊文件。那由于我们先前在该特殊文件中启动了 ","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"bJiK6byfBl"},{"type":"inlineCode","value":"http()","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"QRDQbboCqC"},{"type":"text","value":" 函数，这样就能快捷方便地把 MCP Server 启动起来了！对于我们的 ","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"FFp1oWw4QI"},{"type":"inlineCode","value":"get_weather_mcp","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"i16dB8C1Az"},{"type":"text","value":"，启动命令如下：","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"cmCSxaSsZo"}],"key":"bLzqC686gz"},{"type":"code","lang":"bash","value":"python -m get_weather_mcp","position":{"start":{"line":26,"column":1},"end":{"line":28,"column":1}},"key":"oGDyN5YphP"},{"type":"heading","depth":3,"position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"children":[{"type":"text","value":"2）算数 MCP","position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"key":"zB6ttd6W3s"}],"identifier":"id-2-mcp","label":"2）算数 MCP","html_id":"id-2-mcp","implicit":true,"key":"e5ytlu5R50"},{"type":"paragraph","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"children":[{"type":"text","value":"这还需要赘述吗？开发流程照抄上面的步骤。","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"kJ1nNM0pK1"}],"key":"ko68KyQ6pX"},{"type":"paragraph","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"children":[{"type":"text","value":"真的是超级模版化。","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"RYxqU0mhpk"},{"type":"inlineCode","value":"__init__.py","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"n7iaicCqXT"},{"type":"text","value":" 和 ","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"wX61A1j58I"},{"type":"inlineCode","value":"__main__.py","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"eJ0dlnzBi8"},{"type":"text","value":" 几乎完全相同。","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"pUUrZy85Pk"}],"key":"uQLLZH1snE"},{"type":"paragraph","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"children":[{"type":"text","value":"唯一需要改动的是 ","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"XvSOfqo2EW"},{"type":"inlineCode","value":"__main__.py","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"Tf6LfU1Tew"},{"type":"text","value":"。需要把端口 ","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"W13zWSFWoS"},{"type":"inlineCode","value":"port","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"sEzVFUE86y"},{"type":"text","value":" 改成新号码，一般来说加 1 就行。这里我们把 8000 改成 8001，其他不变：","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"KBHmNIF48S"}],"key":"igiS0EEHTY"},{"type":"code","lang":"python","value":"# -*- coding: utf-8 -*-\nimport asyncio\nimport os\n\nfrom . import server\n\n\nhost = os.getenv('HOST', '127.0.0.1')\nport = int(os.getenv('PORT', 8001))\n\n\ndef stdio():\n    \"\"\"Stdio entry point for the package.\"\"\"\n    asyncio.run(server.mcp.run(transport=\"stdio\"))\n\n\ndef http():\n    \"\"\"streamable-http entry point for the package.\"\"\"\n    asyncio.run(server.mcp.run(transport=\"http\",\n                               host=host,\n                               port=port,\n                               path=\"/mcp\"))\n\n\nif __name__ == \"__main__\":\n    http()","position":{"start":{"line":38,"column":1},"end":{"line":65,"column":1}},"key":"iz1CetfW8N"},{"type":"heading","depth":3,"position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"children":[{"type":"text","value":"二、使用 ","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"vzVfDIETVA"},{"type":"inlineCode","value":"supervisord","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"u768eBqQLb"},{"type":"text","value":" 管理 MCP 服务","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"nUepq7V9a4"}],"identifier":"id-supervisord-mcp","label":"二、使用 supervisord 管理 MCP 服务","html_id":"id-supervisord-mcp","implicit":true,"key":"C1XqhP5Uiy"},{"type":"paragraph","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"children":[{"type":"link","url":"https://github.com/Supervisor/supervisor","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"children":[{"type":"text","value":"supervisord","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"key":"NT1xf7JLpa"}],"urlSource":"https://github.com/Supervisor/supervisor","error":true,"key":"wbhhLpfzRL"},{"type":"text","value":" 是一个 进程管理工具。你告诉它有哪些 MCP 要跑，它会守护你的 MCP 宝宝。当 MCP 挂掉的时候，supervisord 能够自动拉起 MCP。这块内容在我的博客 ","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"key":"gsy2GYz82W"},{"type":"link","url":"https://luochang212.github.io/posts/process_manager/","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"children":[{"type":"text","value":"《后台管理工具介绍》","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"key":"aFHJrX0NpU"}],"urlSource":"https://luochang212.github.io/posts/process_manager/","key":"XqQHVuzJN9"},{"type":"text","value":" 中有做简略的介绍（但更多是关于 ","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"key":"wlYZVwysLk"},{"type":"inlineCode","value":"systemd","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"key":"vvl8pQJKFi"},{"type":"text","value":" 和 ","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"key":"K464hBMDZP"},{"type":"inlineCode","value":"pm2","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"key":"m8lYGAEWah"},{"type":"text","value":" 的）。","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"key":"lN20NQXO4c"}],"key":"xHrPNp7bpI"},{"type":"paragraph","position":{"start":{"line":71,"column":1},"end":{"line":71,"column":1}},"children":[{"type":"text","value":"首先，我们打开项目的 ","position":{"start":{"line":71,"column":1},"end":{"line":71,"column":1}},"key":"ZJ3wInp3sQ"},{"type":"inlineCode","value":"mcp_server","position":{"start":{"line":71,"column":1},"end":{"line":71,"column":1}},"key":"rUSQJtB408"},{"type":"text","value":" 路径，在这里创建一个配置文件 ","position":{"start":{"line":71,"column":1},"end":{"line":71,"column":1}},"key":"f3O01sXp67"},{"type":"inlineCode","value":"mcp_supervisor.conf","position":{"start":{"line":71,"column":1},"end":{"line":71,"column":1}},"key":"yriDTnCpmy"},{"type":"text","value":"，来给 ","position":{"start":{"line":71,"column":1},"end":{"line":71,"column":1}},"key":"koKUk7CX5v"},{"type":"inlineCode","value":"supervisord","position":{"start":{"line":71,"column":1},"end":{"line":71,"column":1}},"key":"gRlEaauOsl"},{"type":"text","value":" 使用。我的配置如下：","position":{"start":{"line":71,"column":1},"end":{"line":71,"column":1}},"key":"GUX1QGCVki"}],"key":"znQj44DNZq"},{"type":"code","lang":"","value":"[unix_http_server]\nfile=/tmp/supervisor.sock\n\n[supervisord]\nlogfile=/tmp/supervisord.log\nlogfile_maxbytes=50MB\nlogfile_backups=10\nloglevel=info\npidfile=/tmp/supervisord.pid\nnodaemon=false\nminfds=1024\nminprocs=200\n\n[rpcinterface:supervisor]\nsupervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface\n\n[supervisorctl]\nserverurl=unix:///tmp/supervisor.sock\n\n[program:math_mcp]\ncommand=python -m mcp_server.math_mcp\ndirectory=..\nautostart=true\nautorestart=true\nstartsecs=5\nstopwaitsecs=10\nstdout_logfile=/tmp/math_mcp.log\nstderr_logfile=/tmp/math_mcp_err.log\n\n[program:weather_mcp]\ncommand=python -m mcp_server.get_weather_mcp\ndirectory=..\nautostart=true\nautorestart=true\nstartsecs=5\nstopwaitsecs=10\nstdout_logfile=/tmp/weather_mcp.log\nstderr_logfile=/tmp/weather_mcp_err.log\n\n[group:mcp_servers]\nprograms=math_mcp,weather_mcp","position":{"start":{"line":73,"column":1},"end":{"line":115,"column":1}},"key":"Pr3q3mfazC"},{"type":"paragraph","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"children":[{"type":"text","value":"至此，","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"key":"AzVcwZIltR"},{"type":"inlineCode","value":"math_mcp","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"key":"ty3NOrR1dA"},{"type":"text","value":"、","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"key":"gg5U41xAtg"},{"type":"inlineCode","value":"weather_mcp","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"key":"pt5YYhpKEU"},{"type":"text","value":" 的配置就完成了。这种东西没必要自己写，我是让 ","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"key":"Xf0QHhBHNf"},{"type":"link","url":"https://www.trae.ai/","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"children":[{"type":"text","value":"TRAE","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"key":"Wi3aiAR5Vs"}],"urlSource":"https://www.trae.ai/","key":"hdUrrLXgmm"},{"type":"text","value":" 帮我写的。下面是关于常用命令的说明！","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"key":"qyAOJmIhDg"}],"key":"OQtHXOtHe9"},{"type":"heading","depth":3,"position":{"start":{"line":119,"column":1},"end":{"line":119,"column":1}},"children":[{"type":"text","value":"1）安装 ","position":{"start":{"line":119,"column":1},"end":{"line":119,"column":1}},"key":"O8Qfz9u6wZ"},{"type":"inlineCode","value":"supervisord","position":{"start":{"line":119,"column":1},"end":{"line":119,"column":1}},"key":"sGFVXQvakX"}],"identifier":"id-1-supervisord","label":"1）安装 supervisord","html_id":"id-1-supervisord","implicit":true,"key":"YzWkZZRJV4"},{"type":"code","lang":"bash","value":"pip install supervisor","position":{"start":{"line":121,"column":1},"end":{"line":123,"column":1}},"key":"aIBOqz1LwM"},{"type":"heading","depth":3,"position":{"start":{"line":125,"column":1},"end":{"line":125,"column":1}},"children":[{"type":"text","value":"2）启动 ","position":{"start":{"line":125,"column":1},"end":{"line":125,"column":1}},"key":"fyL3ELBSWb"},{"type":"inlineCode","value":"supervisord","position":{"start":{"line":125,"column":1},"end":{"line":125,"column":1}},"key":"s9tKlvlWHg"}],"identifier":"id-2-supervisord","label":"2）启动 supervisord","html_id":"id-2-supervisord","implicit":true,"key":"hcDueMvrhX"},{"type":"code","lang":"bash","value":"supervisord -c ./mcp_supervisor.conf","position":{"start":{"line":127,"column":1},"end":{"line":129,"column":1}},"key":"mb58xkUBdX"},{"type":"heading","depth":3,"position":{"start":{"line":131,"column":1},"end":{"line":131,"column":1}},"children":[{"type":"text","value":"3）关闭 ","position":{"start":{"line":131,"column":1},"end":{"line":131,"column":1}},"key":"zxNnKdjBq5"},{"type":"inlineCode","value":"supervisord","position":{"start":{"line":131,"column":1},"end":{"line":131,"column":1}},"key":"vwQSKseXgU"}],"identifier":"id-3-supervisord","label":"3）关闭 supervisord","html_id":"id-3-supervisord","implicit":true,"key":"ZVgJ2TlALd"},{"type":"code","lang":"bash","value":"pkill -f supervisord","position":{"start":{"line":133,"column":1},"end":{"line":135,"column":1}},"key":"Mlqp1QjHCi"},{"type":"heading","depth":3,"position":{"start":{"line":137,"column":1},"end":{"line":137,"column":1}},"children":[{"type":"text","value":"4）检查端口状态","position":{"start":{"line":137,"column":1},"end":{"line":137,"column":1}},"key":"zevxQzpH7V"}],"identifier":"id-4","label":"4）检查端口状态","html_id":"id-4","implicit":true,"key":"wXogF0PmWA"},{"type":"code","lang":"bash","value":"lsof -i :8000\nlsof -i :8001","position":{"start":{"line":139,"column":1},"end":{"line":142,"column":1}},"key":"vzOC6WJh9D"}],"key":"IgRyVed7uT"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"三、在 LangGraph 中使用 MCP","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MBxHNxtBrj"}],"identifier":"id-langgraph-mcp","label":"三、在 LangGraph 中使用 MCP","html_id":"id-langgraph-mcp","implicit":true,"key":"xWjXxbQaXk"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"在使用之前，需要安装配适该功能的 Python 包：","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"WF1y1QRueT"}],"key":"koitbW50Qb"},{"type":"code","lang":"","value":"pip install langchain-mcp-adapters","position":{"start":{"line":5,"column":1},"end":{"line":7,"column":1}},"key":"JRCegOaKu4"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"我也是服了开发团队，依我看 ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"Z1JsXnxoUJ"},{"type":"inlineCode","value":"LangChain","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"V3G0uI0HgV"},{"type":"text","value":"、","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"YJ8Wgbgi4O"},{"type":"inlineCode","value":"LangGraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"BMeWTeBFar"},{"type":"text","value":" 不如合成一个包。还要我们去功能在哪个包里，真费劲！而且各种功能也被拆得稀碎，看看我到目前为止都安装多少包了：","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"OpebKHbwNJ"}],"key":"jaxAhdovW2"},{"type":"code","lang":"bash","value":"langchain[openai]\nlangchain-mcp-adapters\nlanggraph\nlanggraph-cli[inmem]\nlanggraph-supervisor\nlanggraph-checkpoint-sqlite","position":{"start":{"line":11,"column":1},"end":{"line":18,"column":1}},"key":"JIO8rfSbFH"},{"type":"paragraph","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"text","value":"若非 ","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"EtJxfYR8wF"},{"type":"inlineCode","value":"LangGraph 1.0","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"yYyapdLZlI"},{"type":"text","value":" 更新了不少好功能，我是打心眼里看不上这个开源项目。衷心祝愿后起之秀 ","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"SwWkYVt39U"},{"type":"link","url":"https://github.com/agentscope-ai/agentscope","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"text","value":"AgentScope","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"jrhpwxQQEb"}],"urlSource":"https://github.com/agentscope-ai/agentscope","error":true,"key":"wAJz2aXc04"},{"type":"text","value":" 吸收 ","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"SofPFcp0Fk"},{"type":"inlineCode","value":"LangGraph 1.0","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"Ry3AROCpi6"},{"type":"text","value":" 的长处并超越它。当然在此之前，我们得承认 ","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"S4kTF1Tqkk"},{"type":"inlineCode","value":"LangGraph","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"WHK7L6VOOq"},{"type":"text","value":" 的地位。它虽不完美，但依然是最强大的那个。","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"LvLbsewDjF"}],"key":"YVGDNy6p5M"},{"type":"heading","depth":3,"position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"text","value":"1）启动 MCP 服务","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"GDeT8qqbZc"}],"identifier":"id-1-mcp","label":"1）启动 MCP 服务","html_id":"id-1-mcp-1","implicit":true,"key":"UIxhVAGWUc"},{"type":"paragraph","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"text","value":"我们只启动天气 MCP。算数 MCP 稍后我们将以 stdio 的方式调用，无需单独启动服务。","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"p5YTEzY8Ya"}],"key":"fcbK1rg92L"},{"type":"paragraph","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"children":[{"type":"text","value":"启动 ","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"rnbUbk3ja4"},{"type":"inlineCode","value":"get_weather_mcp","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"kWEIQw9nYL"},{"type":"text","value":"：","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"AXbu2vtzgA"}],"key":"AileT9JS62"},{"type":"code","lang":"bash","value":"python -m mcp_server.get_weather_mcp ","position":{"start":{"line":28,"column":1},"end":{"line":30,"column":1}},"key":"lwjrY0gQ2s"},{"type":"paragraph","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"children":[{"type":"text","value":"测试 MCP Server 是否成功启动：","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"mX5WTZYhTS"}],"key":"CEvzFd9HfS"}],"key":"mTOCMw8RHu"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# !lsof -i :8000","key":"utg7Bo39mq"},{"type":"output","id":"DCEs888swVQNP1OCUSdLO","data":[],"key":"YCi2mS0AAe"}],"key":"iZvl3CpKlr"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2）接入 MCP 服务","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RWkyjdg0Qy"}],"identifier":"id-2-mcp","label":"2）接入 MCP 服务","html_id":"id-2-mcp-1","implicit":true,"key":"oJRHe8mANG"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"使用 ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"XXPaXbUfS0"},{"type":"inlineCode","value":"MultiServerMCPClient","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"mkzhlf1rli"},{"type":"text","value":" 接入 MCP Server.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qRYSrPl5jY"}],"key":"ORfZDdfe8G"}],"key":"WwQoWmQyyC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\n\nfrom dotenv import load_dotenv\nfrom langchain_openai import ChatOpenAI\nfrom langchain_mcp_adapters.client import MultiServerMCPClient  \nfrom langchain.agents import create_agent\n\n# 加载模型配置\n_ = load_dotenv()\n\n# 加载模型\nllm = ChatOpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n    model=\"qwen3-coder-plus\",\n    temperature=0.7,\n)\n\nasync def mcp_agent():\n    # 我们用两种方式启动 MCP Server：stdio 和 streamable_http\n    client = MultiServerMCPClient(  \n        {\n            \"math\": {\n                \"command\": \"python\",\n                \"args\": [os.path.abspath(\"./mcp_server/math_mcp/server.py\")],\n                \"transport\": \"stdio\",\n            },\n            \"weather\": {\n                \"url\": \"http://localhost:8000/mcp\",\n                \"transport\": \"streamable_http\",\n            }\n        }\n    )\n    \n    tools = await client.get_tools()\n    agent = create_agent(\n        llm,\n        tools=tools,\n    )\n\n    return agent\n\nasync def use_mcp(messages):\n    agent = await mcp_agent()\n    response = await agent.ainvoke(messages)\n    return response","key":"OPdWckXjGb"},{"type":"output","id":"NC-J7EDZagCZqMxemHq6X","data":[],"key":"OJXjk8Sziq"}],"key":"duepDRa7Ea"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"在 Jupyter Notebook 中，使用 ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Y05UGtXx3I"},{"type":"inlineCode","value":"response = await use_mcp(messages)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"K8YYNN5cKe"},{"type":"text","value":" 命令调用函数。但是在 ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Qmhw1wkNN9"},{"type":"inlineCode","value":".py","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pDLo1I9W72"},{"type":"text","value":" 文件中，这种调用方法会失败。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lWoMzydG51"}],"key":"G1aPznIDWv"}],"key":"VzdtpyTBFQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 调用天气 MCP\nmessages = {\"messages\": [{\"role\": \"user\", \"content\": \"福州天气怎么样？\"}]}\nresponse = await use_mcp(messages)\nresponse[\"messages\"][-1].content","key":"bp1REDOVoH"},{"type":"output","id":"IByaNmMc2sUXumKyvGHSU","data":[{"output_type":"execute_result","execution_count":3,"metadata":{},"data":{"text/plain":{"content":"'福州的天气总是晴朗明媚！如果您计划前往福州，可以期待阳光充足的天气。不过，建议您出行前还是查看一下最新的天气预报，以确保做好相应的准备。'","content_type":"text/plain"}}}],"key":"bL29Fk3Ill"}],"key":"xPHn5OFhPS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 调用算数 MCP，由于是 stdio，启动会慢一点\nmessages = {\"messages\": [{\"role\": \"user\", \"content\": \"计算 (3 + 5) * 12\"}]}\nresponse = await use_mcp(messages)\nresponse[\"messages\"][-1].content","key":"MYuqAhl09K"},{"type":"output","id":"LNx9HJSYeK9P8GTgmlcVO","data":[{"output_type":"execute_result","execution_count":4,"metadata":{},"data":{"text/plain":{"content":"'(3 + 5) * 12 的结果是 96。'","content_type":"text/plain"}}}],"key":"fQ6Sbnq9pv"}],"key":"pbfxPt2fvo"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"在 ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"r8oVXHxSTU"},{"type":"inlineCode","value":".py","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ETxPMbGl52"},{"type":"text","value":" 文件中，应该使用 ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GqTz4jorIP"},{"type":"inlineCode","value":"asyncio","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TRijxWYxnr"},{"type":"text","value":"，改动部分如下：","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jgkAZj4wzo"}],"key":"Xo0dp3q2de"},{"type":"code","lang":"python","value":"import asyncio\n\nasync def main():\n    # 调用天气 MCP\n    messages = {\"messages\": [{\"role\": \"user\", \"content\": \"福州天气怎么样？\"}]}\n    response = await use_mcp(messages)\n    print(response[\"messages\"][-1].content)\n\nif __name__ == \"__main__\":\n    asyncio.run(main())\n","position":{"start":{"line":3,"column":1},"end":{"line":15,"column":1}},"key":"bNFMSsOx7h"}],"key":"EJXb4XueaA"}],"key":"oZ1jBLDCBr"},"references":{"cite":{"order":[],"data":{}}}}