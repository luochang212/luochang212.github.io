{"version":2,"kind":"Notebook","sha256":"0dca0122de4980622824c62c87025bb57298ccb31890c8dbe2c559dfeb779949","slug":"context","location":"/6.context.ipynb","dependencies":[],"frontmatter":{"title":"ä¸Šä¸‹æ–‡å·¥ç¨‹","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"github":"https://github.com/luochang212/langgraph-tutorial","keywords":["LangGraph","Langchain"],"source_url":"https://github.com/luochang212/langgraph-tutorial/blob/main/6.context.ipynb","edit_url":"https://github.com/luochang212/langgraph-tutorial/edit/main/6.context.ipynb","exports":[{"format":"ipynb","filename":"6.context.ipynb","url":"/6.context-a085240f90110c385d4c18b4b32b9ed6.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langchain/context-engineering","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"ä¸Šä¸‹æ–‡å·¥ç¨‹","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Se8PJCyki2"}],"urlSource":"https://docs.langchain.com/oss/python/langchain/context-engineering","key":"hsYp2KZWPw"},{"type":"text","value":"ï¼ˆContext Engineeringï¼‰å¯¹äº LLM å¾—å‡ºæ­£ç¡®çš„ç»“æœè‡³å…³é‡è¦ã€‚å¾ˆå¤šæ—¶å€™ï¼Œæ¨¡å‹å›ç­”ä¸å¥½å¹¶éå› ä¸ºæ¨¡å‹èƒ½åŠ›ä¸è¶³ï¼Œè€Œæ˜¯å› ä¸ºæ²¡æœ‰è·å¾—è¶³ä»¥æ¨æ–­å‡ºæ­£ç¡®ç»“æœçš„ä¿¡æ¯ã€‚LangGraph å¯ä»¥é€šè¿‡ä¸Šä¸‹æ–‡å·¥ç¨‹ï¼Œå¢å¼ºä¸Šä¸‹æ–‡çš„ç®¡ç†èƒ½åŠ›ã€‚","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"JEyZEBWWTS"}],"key":"YRjld24v2Q"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"æŒ‰å‘ç”Ÿä½œç”¨çš„ä½ç½®åˆ†ï¼Œå¯å°†ä¸Šä¸‹æ–‡åˆ†ä¸ºï¼š","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"qyRhG3RT29"}],"key":"gNLTNwIsPQ"}],"key":"FKpFiYKypY"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"æ¨¡å‹ä¸Šä¸‹æ–‡ï¼ˆModel Contextï¼‰","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"MUfdUN0Sed"}],"key":"YMb1tu1d3M"}],"key":"AgEVODPLLD"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"å·¥å…·ä¸Šä¸‹æ–‡ï¼ˆTool Contextï¼‰","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"xvVWaxqjWN"}],"key":"WmSe0Bm39L"}],"key":"PLuKHzBGuu"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"ç”Ÿå‘½å‘¨æœŸä¸Šä¸‹æ–‡ï¼ˆLift-cycle Contextï¼‰","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"fM9KPUi3AE"}],"key":"JBGq2aw1pF"}],"key":"CvDbONt4XH"}],"key":"ncJEclJy5P"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"LangGraph æä¾›äº†ç›¸å½“å¤§çš„è‡ªç”±åº¦ï¼Œä½ å¯ä»¥ä½¿ç”¨ ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"LEtvTogN9i"},{"type":"inlineCode","value":"dataclasses","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"gbtnwHumZ6"},{"type":"text","value":"ã€","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"Ipany8Rhmi"},{"type":"inlineCode","value":"pydantic","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"KSap207jCS"},{"type":"text","value":"ã€","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"MinXnQ2uFD"},{"type":"inlineCode","value":"TypedDict","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"Tx9P4aRu45"},{"type":"text","value":" ä¸­çš„ä»»æ„ä¸€ä¸ªåˆ›å»º Context Schema.","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"GBqBKcOUMs"}],"key":"ou0ILi6MFo"}],"key":"EaagINQcTv"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# !pip install ipynbname","key":"jQLVCFuSX6"},{"type":"output","id":"-PaclCijm7itd3kHorbpq","data":[],"key":"AaxpNwkmZZ"}],"key":"rWnN9fT9lx"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nimport uuid\nimport sqlite3\n\nfrom typing import Callable\nfrom dotenv import load_dotenv\nfrom dataclasses import dataclass\nfrom langchain_openai import ChatOpenAI\nfrom langchain.tools import tool, ToolRuntime\nfrom langchain.agents import create_agent\nfrom langchain.agents.middleware import dynamic_prompt, wrap_model_call, ModelRequest, ModelResponse, SummarizationMiddleware\nfrom langgraph.graph import StateGraph, MessagesState, START, END\nfrom langgraph.checkpoint.memory import InMemorySaver\nfrom langgraph.store.memory import InMemoryStore\nfrom langgraph.store.sqlite import SqliteStore\n\n# åŠ è½½æ¨¡å‹é…ç½®\n_ = load_dotenv()\n\n# åŠ è½½æ¨¡å‹\nllm = ChatOpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n    model=\"qwen3-coder-plus\",\n    temperature=0.7,\n)","key":"uKyLMqPzXG"},{"type":"output","id":"k1h4ts0sPA7SfBsL4OdYX","data":[],"key":"cJ1DR0LHnu"}],"key":"AgppvWncpm"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"ä¸€ã€åŠ¨æ€ä¿®æ”¹ç³»ç»Ÿæç¤ºè¯","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"j40U7eTteG"}],"identifier":"id","label":"ä¸€ã€åŠ¨æ€ä¿®æ”¹ç³»ç»Ÿæç¤ºè¯","html_id":"id","implicit":true,"key":"wD5hYZR3Kb"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"ä¸Šä¸‹æ–‡å·¥ç¨‹ä¸å‰åºç« èŠ‚çš„ä¸­é—´ä»¶ï¼ˆmiddlewareï¼‰å’Œè®°å¿†ï¼ˆmemoryï¼‰å¯†ä¸å¯åˆ†ã€‚ä¸Šä¸‹æ–‡çš„å…·ä½“å®ç°ä¾èµ–ä¸­é—´ä»¶ï¼Œè€Œä¸Šä¸‹æ–‡çš„å­˜å‚¨åˆ™ä¾èµ–è®°å¿†ç³»ç»Ÿã€‚å…·ä½“æ¥è®²ï¼ŒLangGraph é¢„ç½®äº† ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"nKlEdoxgs7"},{"type":"inlineCode","value":"@dynamic_prompt","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"a0jdhEYbj2"},{"type":"text","value":" ä¸­é—´ä»¶ï¼Œç”¨äºåŠ¨æ€ä¿®æ”¹ç³»ç»Ÿæç¤ºè¯ã€‚","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"cEbkitHvRu"}],"key":"XA8nC2Tfk7"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"æ—¢ç„¶æ˜¯åŠ¨æ€ä¿®æ”¹ï¼Œè‚¯å®šéœ€è¦æŸä¸ªæ¡ä»¶æ¥è§¦å‘ä¿®æ”¹ã€‚é™¤äº†å¼€å‘è§¦å‘é€»è¾‘ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä»æ™ºèƒ½ä½“ä¸­è·å–è§¦å‘é€»è¾‘æ‰€éœ€çš„å³æ—¶å˜é‡ã€‚è¿™äº›å˜é‡é€šå¸¸å­˜å‚¨åœ¨ä»¥ä¸‹ä¸‰ä¸ªå­˜å‚¨ä»‹è´¨ä¸­ï¼š","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"detf8mSPmV"}],"key":"xve6wDCwP7"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰- æ‰€æœ‰èŠ‚ç‚¹å…±äº«ä¸€ä¸ª Runtimeã€‚åŒä¸€æ—¶åˆ»ï¼Œæ‰€æœ‰èŠ‚ç‚¹å–åˆ°çš„ Runtime çš„å€¼æ˜¯ç›¸åŒçš„ã€‚ä¸€èˆ¬ç”¨äºå­˜å‚¨æ—¶æ•ˆæ€§è¦æ±‚è¾ƒé«˜çš„ä¿¡æ¯ã€‚","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"icDqoScuM6"}],"key":"A6SwTIIdpO"}],"key":"BtYCxEk8TP"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"çŸ­æœŸè®°å¿†ï¼ˆStateï¼‰- åœ¨èŠ‚ç‚¹ä¹‹é—´æŒ‰é¡ºåºä¼ é€’ï¼Œæ¯ä¸ªèŠ‚ç‚¹æ¥æ”¶ä¸Šä¸€ä¸ªèŠ‚ç‚¹å¤„ç†åçš„ Stateã€‚ä¸»è¦ç”¨äºå­˜å‚¨ Prompt å’Œ AI Messageã€‚","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"kAp9cNnYOr"}],"key":"D0kBQ6XMZD"}],"key":"Kqv7AUE3Cs"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"é•¿æœŸè®°å¿†ï¼ˆStoreï¼‰- è´Ÿè´£æŒä¹…åŒ–å­˜å‚¨ï¼Œå¯ä»¥è·¨ Workflow / Agent ä¿å­˜ä¿¡æ¯ã€‚å¯ä»¥ç”¨æ¥å­˜ç”¨æˆ·åå¥½ã€ä»¥å‰ç®—è¿‡çš„ç»Ÿè®¡å€¼ç­‰ã€‚","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"ZOwa7SmxiO"}],"key":"jqopzXnlbF"}],"key":"KLhlNrg0dC"}],"key":"nilByqG5wU"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"ä»¥ä¸‹ä¸‰ä¸ªä¾‹å­ï¼Œåˆ†åˆ«æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨æ¥è‡ª Runtimeã€Stateã€Store ä¸­çš„ä¸Šä¸‹æ–‡ï¼Œç¼–å†™è§¦å‘æ¡ä»¶ã€‚","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"IqMB13WeGZ"}],"key":"HaRrFfkVnI"},{"type":"heading","depth":3,"position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"1ï¼‰ä½¿ç”¨ ","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"JFux8t6fMM"},{"type":"inlineCode","value":"State","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"JTPQzPCj0J"},{"type":"text","value":" åŠ è½½ä¸Šä¸‹æ–‡","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"uoua72CZ5s"}],"identifier":"id-1-state","label":"1ï¼‰ä½¿ç”¨ State åŠ è½½ä¸Šä¸‹æ–‡","html_id":"id-1-state","implicit":true,"key":"Sv5aDWKR60"},{"type":"paragraph","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"åˆ©ç”¨ ","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"KWdqJT0rg4"},{"type":"inlineCode","value":"State","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"Qhp4KvHBmN"},{"type":"text","value":" ä¸­è•´å«çš„ä¿¡æ¯æ“çºµ system prompt.","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"ChJf9257sD"}],"key":"gkSURCkAOy"}],"key":"KYNFQZa9Fe"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"@dynamic_prompt\ndef state_aware_prompt(request: ModelRequest) -> str:\n    # request.messages is a shortcut for request.state[\"messages\"]\n    message_count = len(request.messages)\n\n    base = \"You are a helpful assistant.\"\n\n    if message_count > 6:\n        base += \"\\nThis is a long conversation - be extra concise.\"\n\n    # ä¸´æ—¶æ‰“å°baseçœ‹æ•ˆæœ\n    print(base)\n\n    return base\n\nagent = create_agent(\n    model=llm,\n    middleware=[state_aware_prompt]\n)\n\nresult = agent.invoke(\n    {\"messages\": [\n        {\"role\": \"user\", \"content\": \"å¹¿å·ä»Šå¤©çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ\"},\n        {\"role\": \"assistant\", \"content\": \"å¹¿å·å¤©æ°”å¾ˆå¥½\"},\n        {\"role\": \"user\", \"content\": \"åƒç‚¹ä»€ä¹ˆå¥½å‘¢\"},\n        {\"role\": \"assistant\", \"content\": \"è¦ä¸è¦åƒé¦™èŒ…é³—é±¼ç…²\"},\n        {\"role\": \"user\", \"content\": \"é¦™èŒ…æ˜¯ä»€ä¹ˆ\"},\n        {\"role\": \"assistant\", \"content\": \"é¦™èŒ…åˆåæŸ æª¬è‰ï¼Œå¸¸è§äºæ³°å¼å†¬é˜´åŠŸæ±¤ã€è¶Šå—çƒ¤è‚‰\"},\n        {\"role\": \"user\", \"content\": \"auv é‚£è¿˜ç­‰ä»€ä¹ˆï¼Œå’±åƒå»å§\"},\n    ]},\n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"osyUOYM54k"},{"type":"output","id":"XwQL1bDMAYVfUIMZv6LHu","data":[{"name":"stdout","output_type":"stream","text":"You are a helpful assistant.\nThis is a long conversation - be extra concise.\n================================\u001b[1m Human Message \u001b[0m=================================\n\nå¹¿å·ä»Šå¤©çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nå¹¿å·å¤©æ°”å¾ˆå¥½\n================================\u001b[1m Human Message \u001b[0m=================================\n\nåƒç‚¹ä»€ä¹ˆå¥½å‘¢\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nè¦ä¸è¦åƒé¦™èŒ…é³—é±¼ç…²\n================================\u001b[1m Human Message \u001b[0m=================================\n\né¦™èŒ…æ˜¯ä»€ä¹ˆ\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\né¦™èŒ…åˆåæŸ æª¬è‰ï¼Œå¸¸è§äºæ³°å¼å†¬é˜´åŠŸæ±¤ã€è¶Šå—çƒ¤è‚‰\n================================\u001b[1m Human Message \u001b[0m=================================\n\nauv é‚£è¿˜ç­‰ä»€ä¹ˆï¼Œå’±åƒå»å§\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nå¥½ä¸»æ„ï¼é¦™èŒ…é³—é±¼ç…²å¬èµ·æ¥å¾ˆç¾å‘³ï¼Œèµ°å§ï¼\n"}],"key":"YenL5FIH6t"}],"key":"zXCdYtctUl"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"æŠŠ ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jeoNiUPwmL"},{"type":"inlineCode","value":"message_count > 6","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zSAmk1FI7n"},{"type":"text","value":" é‡Œçš„ 6 æ”¹æˆ 7ï¼Œè¯•è¯•çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cVSSuj47MY"}],"key":"qkZBCyNCvN"}],"key":"RfgUMVSgrE"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2ï¼‰ä½¿ç”¨ ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vlmRIdPPFU"},{"type":"inlineCode","value":"Store","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LWFFwfqcIA"},{"type":"text","value":" åŠ è½½ä¸Šä¸‹æ–‡","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"QVPG2Pxq8s"}],"identifier":"id-2-store","label":"2ï¼‰ä½¿ç”¨ Store åŠ è½½ä¸Šä¸‹æ–‡","html_id":"id-2-store","implicit":true,"key":"qesHoYMrNe"}],"key":"FwDltl5HR8"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"@dataclass\nclass Context:\n    user_id: str\n\n@dynamic_prompt\ndef store_aware_prompt(request: ModelRequest) -> str:\n    user_id = request.runtime.context.user_id\n\n    # Read from Store: get user preferences\n    store = request.runtime.store\n    user_prefs = store.get((\"preferences\",), user_id)\n\n    base = \"You are a helpful assistant.\"\n\n    if user_prefs:\n        style = user_prefs.value.get(\"communication_style\", \"balanced\")\n        base += f\"\\nUser prefers {style} responses.\"\n\n    return base\n\nstore = InMemoryStore()\n\nagent = create_agent(\n    model=llm,\n    middleware=[store_aware_prompt],\n    context_schema=Context,\n    store=store,\n)\n\n# é¢„ç½®ä¸¤æ¡åå¥½ä¿¡æ¯\nstore.put((\"preferences\",), \"user_1\", {\"communication_style\": \"Chinese\"})\nstore.put((\"preferences\",), \"user_2\", {\"communication_style\": \"Korean\"})","key":"bxKVhNbWlO"},{"type":"output","id":"Fc3YSFNC_px-9C0Vfx0jr","data":[],"key":"QNZBlQIthh"}],"key":"Pyw6JiJ5rz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# ç”¨æˆ·1å–œæ¬¢ä¸­æ–‡å›å¤\nresult = agent.invoke(\n    {\"messages\": [\n        {\"role\": \"system\", \"content\": \"You are a helpful assistant. Please be extra concise.\"},\n        {\"role\": \"user\", \"content\": 'What is a \"hold short line\"?'}\n    ]},\n    context=Context(user_id=\"user_1\"),\n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"Y8jIbEUzLE"},{"type":"output","id":"6vejhaumowWeibKv6O66-","data":[{"name":"stdout","output_type":"stream","text":"================================\u001b[1m System Message \u001b[0m================================\n\nYou are a helpful assistant. Please be extra concise.\n================================\u001b[1m Human Message \u001b[0m=================================\n\nWhat is a \"hold short line\"?\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\n\"Hold short line\" æ˜¯èˆªç©ºæœ¯è¯­ï¼ŒæŒ‡è·‘é“æˆ–æ»‘è¡Œé“ä¸Šçš„ä¸€æ¡æ ‡è®°çº¿ï¼Œè¦æ±‚é£æœºåœ¨æ­¤çº¿å‰åœæ­¢ï¼Œä¸å¾—è¶Šè¿‡ã€‚é€šå¸¸ç”¨äºï¼š\n\n1. **è·‘é“ç­‰å¾…çº¿** - ç­‰å¾…èµ·é£è®¸å¯\n2. **æ»‘è¡Œé“ç­‰å¾…çº¿** - ç­‰å¾…è¿›å…¥è·‘é“æˆ–å…¶ä»–åŒºåŸŸ\n\nè¿™æ˜¯é£è¡Œå®‰å…¨çš„é‡è¦ç¨‹åºã€‚\n"}],"key":"P7aXIA7XuZ"}],"key":"dnp6KTvfNu"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# ç”¨æˆ·2å–œæ¬¢éŸ©æ–‡å›å¤\nresult = agent.invoke(\n    {\"messages\": [\n        {\"role\": \"system\", \"content\": \"You are a helpful assistant. Please be extra concise.\"},\n        {\"role\": \"user\", \"content\": 'What is a \"hold short line\"?'}\n    ]},\n    context=Context(user_id=\"user_2\"),\n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"CUX186ZgaO"},{"type":"output","id":"vuT7C3XwIIOGHm-IzAQvl","data":[{"name":"stdout","output_type":"stream","text":"================================\u001b[1m System Message \u001b[0m================================\n\nYou are a helpful assistant. Please be extra concise.\n================================\u001b[1m Human Message \u001b[0m=================================\n\nWhat is a \"hold short line\"?\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\n\"í™€ë“œ ì‡¼íŠ¸ ë¼ì¸(Hold Short Line)\"ì€ ê³µí•­ í™œì£¼ë¡œì—ì„œ í•­ê³µê¸°ê°€ íŠ¹ì • ì§€ì ê¹Œì§€ë§Œ ì§„ì…í•˜ë„ë¡ ì§€ì‹œí•˜ëŠ” ì„ ì…ë‹ˆë‹¤. ì´ ì„ ì„ ë„˜ì–´ì„œëŠ” ê²ƒì€ ê¸ˆì§€ë˜ì–´ ìˆìœ¼ë©°, ê´€ì œì†Œì˜ í—ˆê°€ë¥¼ ë°›ì•„ì•¼ë§Œ ì§„ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì£¼ë¡œ í™œì£¼ë¡œì™€ êµì°¨í•˜ëŠ” ì§€ì ì´ë‚˜ í™œì£¼ë¡œ ì§„ì… ì „ì— ì„¤ì¹˜ë˜ì–´ ì•ˆì „ì„ í™•ë³´í•©ë‹ˆë‹¤.\n"}],"key":"r096z9uDuX"}],"key":"kwZcoU16G3"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"3ï¼‰ä½¿ç”¨ ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CymeCMOSRR"},{"type":"inlineCode","value":"Runtime","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BjEjbBQlAg"},{"type":"text","value":" åŠ è½½ä¸Šä¸‹æ–‡","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UmqYPRbuDf"}],"identifier":"id-3-runtime","label":"3ï¼‰ä½¿ç”¨ Runtime åŠ è½½ä¸Šä¸‹æ–‡","html_id":"id-3-runtime","implicit":true,"key":"aEay0E3eHB"}],"key":"Mgb7klHEf7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"@dataclass\nclass Context:\n    user_role: str\n    deployment_env: str\n\n@dynamic_prompt\ndef context_aware_prompt(request: ModelRequest) -> str:\n    # Read from Runtime Context: user role and environment\n    user_role = request.runtime.context.user_role\n    env = request.runtime.context.deployment_env\n\n    base = \"You are a helpful assistant.\"\n\n    if user_role == \"admin\":\n        base += \"\\nYou can use the get_weather tool.\"\n    else:\n        base += \"\\nYou are prohibited from using the get_weather tool.\"\n\n    if env == \"production\":\n        base += \"\\nBe extra careful with any data modifications.\"\n\n    return base\n\n@tool\ndef get_weather(city: str) -> str:\n    \"\"\"Get weather for a given city.\"\"\"\n    return f\"It's always sunny in {city}!\"\n\nagent = create_agent(\n    model=llm,\n    tools=[get_weather],\n    middleware=[context_aware_prompt],\n    context_schema=Context,\n    checkpointer=InMemorySaver(),\n)","key":"jw96CoZJ8X"},{"type":"output","id":"VsL8KUAQZ08yPmdNEb3S_","data":[],"key":"JzAmrw958a"}],"key":"O6xMEX96Mx"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# åˆ©ç”¨ Runtime ä¸­çš„ä¸¤ä¸ªå˜é‡ï¼ŒåŠ¨æ€æ§åˆ¶ System prompt\n# å°† user_role è®¾ä¸º adminï¼Œå…è®¸ä½¿ç”¨å¤©æ°”æŸ¥è¯¢å·¥å…·\nconfig = {'configurable': {'thread_id': str(uuid.uuid4())}}\nresult = agent.invoke(\n    {\"messages\": [{\"role\": \"user\", \"content\": \"å¹¿å·ä»Šå¤©çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ\"}]},\n    context=Context(user_role=\"admin\", deployment_env=\"production\"),\n    config=config,\n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"pNrWwLYeeb"},{"type":"output","id":"y780msv2f1_y4Q28uJbcR","data":[{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nå¹¿å·ä»Šå¤©çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ\n==================================\u001b[1m Ai Message \u001b[0m==================================\nTool Calls:\n  get_weather (call_b7a1beefd02f4703a3d0caaa)\n Call ID: call_b7a1beefd02f4703a3d0caaa\n  Args:\n    city: å¹¿å·\n=================================\u001b[1m Tool Message \u001b[0m=================================\nName: get_weather\n\nIt's always sunny in å¹¿å·!\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\næ ¹æ®æˆ‘è·å–çš„ä¿¡æ¯ï¼Œå¹¿å·ä»Šå¤©æ˜¯æ™´å¤©ï¼æ°”æ¸©é€‚å®œï¼Œé˜³å…‰æ˜åªšã€‚å¦‚æœä½ åœ¨å¹¿å·ï¼Œè®°å¾—åšå¥½é˜²æ™’æªæ–½ï¼Œäº«å—ç¾å¥½çš„ä¸€å¤©ï¼\n"}],"key":"xygDD0yk9V"}],"key":"oiM7zsTiPx"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# è‹¥å°† user_role æ”¹ä¸º viewerï¼Œåˆ™æ— æ³•ä½¿ç”¨å¤©æ°”æŸ¥è¯¢å·¥å…·\nconfig = {'configurable': {'thread_id': str(uuid.uuid4())}}\nresult = agent.invoke(\n    {\"messages\": [{\"role\": \"user\", \"content\": \"å¹¿å·ä»Šå¤©çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ\"}]},\n    context=Context(user_role=\"viewer\", deployment_env=\"production\"),\n    config=config,\n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"s5nMOtAGWE"},{"type":"output","id":"0u_tH5PyuWliqVzfQWDj6","data":[{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nå¹¿å·ä»Šå¤©çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\næŠ±æ­‰ï¼Œæˆ‘æ— æ³•è·å–å¤©æ°”ä¿¡æ¯ã€‚æ‚¨å¯ä»¥é€šè¿‡å…¶ä»–é€”å¾„æŸ¥è¯¢å¹¿å·ä»Šå¤©çš„å¤©æ°”ï¼Œä¾‹å¦‚ä½¿ç”¨å¤©æ°”åº”ç”¨æˆ–è®¿é—®å¤©æ°”ç½‘ç«™ã€‚\n"}],"key":"v4xaG7iNZe"}],"key":"RmpemroZDC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"result['messages']","key":"KIiUSdq6Qp"},{"type":"output","id":"6k9x3dcpwbSiJChL5aZ4n","data":[{"output_type":"execute_result","execution_count":10,"metadata":{},"data":{"text/plain":{"content":"[HumanMessage(content='å¹¿å·ä»Šå¤©çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ', additional_kwargs={}, response_metadata={}, id='58493935-80a8-4f05-818d-4fa3ef684657'),\n AIMessage(content='æŠ±æ­‰ï¼Œæˆ‘æ— æ³•è·å–å¤©æ°”ä¿¡æ¯ã€‚æ‚¨å¯ä»¥é€šè¿‡å…¶ä»–é€”å¾„æŸ¥è¯¢å¹¿å·ä»Šå¤©çš„å¤©æ°”ï¼Œä¾‹å¦‚ä½¿ç”¨å¤©æ°”åº”ç”¨æˆ–è®¿é—®å¤©æ°”ç½‘ç«™ã€‚', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 287, 'total_tokens': 313, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_provider': 'openai', 'model_name': 'qwen3-coder-plus', 'system_fingerprint': None, 'id': 'chatcmpl-b3da39f7-8f49-4a63-9794-06bd7578354f', 'finish_reason': 'stop', 'logprobs': None}, id='lc_run--5c17667c-38c3-4856-9610-9d6f4cfd4d16-0', usage_metadata={'input_tokens': 287, 'output_tokens': 26, 'total_tokens': 313, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}})]","content_type":"text/plain"}}}],"key":"KDNv3BppmF"}],"key":"jVbsjTKM4w"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"äºŒã€åŠ¨æ€ä¿®æ”¹æ¶ˆæ¯åˆ—è¡¨","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ihVFDcaqHW"}],"identifier":"id","label":"äºŒã€åŠ¨æ€ä¿®æ”¹æ¶ˆæ¯åˆ—è¡¨","html_id":"id-1","implicit":true,"key":"IPUdozFjbW"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"LangGraph é¢„åˆ¶äº†åŠ¨æ€ä¿®æ”¹æ¶ˆæ¯åˆ—è¡¨ï¼ˆMessagesï¼‰çš„ä¸­é—´ä»¶ ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"D8ZloOlak0"},{"type":"inlineCode","value":"@wrap_model_call","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"KTNLwDECyw"},{"type":"text","value":"ã€‚ä¸Šä¸€èŠ‚å·²ç»æ¼”ç¤ºå¦‚ä½•ä» ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"uU8sJ7sP0G"},{"type":"inlineCode","value":"State","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"wGyW4qhBsJ"},{"type":"text","value":"ã€","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ovpTZYjrKf"},{"type":"inlineCode","value":"Store","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"I2i5ngV3wh"},{"type":"text","value":"ã€","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"StDFevGNd0"},{"type":"inlineCode","value":"Runtime","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"RtxNm1nHAK"},{"type":"text","value":" ä¸­è·å–ä¸Šä¸‹æ–‡ï¼Œæœ¬èŠ‚å°†ä¸å†ä¸€ä¸€æ¼”ç¤ºã€‚åœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"oVLwhqSjP0"},{"type":"inlineCode","value":"Runtime","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"HRC6Hwgy0X"},{"type":"text","value":" å°†æœ¬åœ°æ–‡ä»¶çš„å†…å®¹æ³¨å…¥æ¶ˆæ¯åˆ—è¡¨ã€‚","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"lCeptMUs16"}],"key":"rTG7gZS76e"}],"key":"A1Z7xUQoUX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"@dataclass\nclass FileContext:\n    uploaded_files: list[dict]\n\n@wrap_model_call\ndef inject_file_context(\n    request: ModelRequest,\n    handler: Callable[[ModelRequest], ModelResponse]\n) -> ModelResponse:\n    \"\"\"Inject context about files user has uploaded this session.\"\"\"\n    uploaded_files = request.runtime.context.uploaded_files\n\n    try:\n        base_dir = os.path.dirname(os.path.abspath(__file__))\n    except Exception as e:\n        import ipynbname\n        import os\n        notebook_path = ipynbname.path()\n        base_dir = os.path.dirname(notebook_path)\n\n    file_sections = []\n    for file in uploaded_files:\n        name, ftype = \"\", \"\"\n        path = file.get(\"path\")\n        if path:\n            base_filename = os.path.basename(path)\n            stem, ext = os.path.splitext(base_filename)\n            name = stem or base_filename\n            ftype = (ext.lstrip(\".\") if ext else None)\n\n            # æ„å»ºæ–‡ä»¶æè¿°å†…å®¹\n            content_list = [f\"åç§°: {name}\"]\n            if ftype:\n                content_list.append(f\"ç±»å‹: {ftype}\")\n\n            # è§£æç›¸å¯¹è·¯å¾„ä¸ºç»å¯¹è·¯å¾„\n            abs_path = path if os.path.isabs(path) else os.path.join(base_dir, path)\n\n            # è¯»å–æ–‡ä»¶å†…å®¹\n            content_block = \"\"\n            if abs_path and os.path.exists(abs_path):\n                try:\n                    with open(abs_path, \"r\", encoding=\"utf-8\") as f:\n                        content_block = f.read()\n                except Exception as e:\n                    content_block = f\"[è¯»å–æ–‡ä»¶é”™è¯¯ '{abs_path}': {e}]\"\n            else:\n                content_block = \"[æ–‡ä»¶è·¯å¾„ç¼ºå¤±æˆ–æœªæ‰¾åˆ°]\"\n\n            section = (\n                f\"---\\n\"\n                f\"{chr(10).join(content_list)}\\n\\n\"\n                f\"{content_block}\\n\"\n                f\"---\"\n            )\n            file_sections.append(section)\n\n        file_context = (\n            \"å·²åŠ è½½çš„ä¼šè¯æ–‡ä»¶ï¼š\\n\"\n            f\"{chr(10).join(file_sections)}\"\n            \"\\nå›ç­”é—®é¢˜æ—¶è¯·å‚è€ƒè¿™äº›æ–‡ä»¶ã€‚\"\n        )\n\n        # Inject file context before recent messages\n        messages = [  \n            *request.messages,\n            {\"role\": \"user\", \"content\": file_context},\n        ]\n        request = request.override(messages=messages)  \n\n    return handler(request)\n\nagent = create_agent(\n    model=llm,\n    middleware=[inject_file_context],\n    context_schema=FileContext,\n)","key":"qYzhGASay2"},{"type":"output","id":"u4JQBazGsX8zSZ1EgG7vJ","data":[],"key":"KdBEKksdpF"}],"key":"svYwgPZS0p"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"result = agent.invoke(\n    {\n        \"messages\": [{\n            \"role\": \"user\",\n            \"content\": \"å…³äºä¸Šæµ·åœ°é“çš„æ— è„¸ä¹˜å®¢ï¼Œæœ‰ä»€ä¹ˆéœ€è¦æ³¨æ„çš„ï¼Ÿ\",\n        }],\n    },\n    context=FileContext(uploaded_files=[{\"path\": \"./docs/rule_horror.md\"}]),\n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"scddsMP2iB"},{"type":"output","id":"3Jq7crQpUWfdPFKked6Mq","data":[{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nå…³äºä¸Šæµ·åœ°é“çš„æ— è„¸ä¹˜å®¢ï¼Œæœ‰ä»€ä¹ˆéœ€è¦æ³¨æ„çš„ï¼Ÿ\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\næ ¹æ®ã€Šä¸Šæµ·è§„åˆ™æ€ªè°ˆã€‹ä¸­çš„æè¿°ï¼Œå…³äºä¸Šæµ·åœ°é“çš„â€œæ— è„¸ä¹˜å®¢â€ï¼Œä½ éœ€è¦ç‰¹åˆ«æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š\n\n---\n\n### ğŸš‡ **åœ°é“ä¸Šçš„é™Œç”Ÿäººï¼ˆæ— è„¸ä¹˜å®¢ï¼‰è§„åˆ™ï¼š**\n\n> **â€œåœ°é“è¿è¥ç»“æŸåï¼Œè‹¥ä½ ä»èº«å¤„è½¦å¢å†…ï¼Œä¼šå‡ºç°ä¸€ä½æ— è„¸ä¹˜å®¢ã€‚ä»–ä¼šä½å£°é—®ï¼šâ€˜ä½ è¦å»å“ªï¼Ÿâ€™åªèƒ½æŠ¥ä¸€ä¸ªçœŸå®å­˜åœ¨çš„ä¸Šæµ·åœ°åã€‚è¯´å‡ºä¸å­˜åœ¨çš„åœ°åæˆ–ä¿æŒæ²‰é»˜ï¼Œä½ ä¼šåœ¨è½¦å¢å†…çœ‹åˆ°è‡ªå·±çš„å°¸ä½“ã€‚â€**\n\n---\n\n### âš ï¸ æ³¨æ„äº‹é¡¹ï¼š\n\n1. **æ—¶é—´ç‚¹ï¼š**  \n   è¯¥ç°è±¡å‘ç”Ÿåœ¨**åœ°é“è¿è¥ç»“æŸä¹‹å**ï¼Œå¦‚æœä½ å› æŸç§åŸå› æ»ç•™åœ¨åœ°é“è½¦å¢å†…ï¼Œè¯·æé«˜è­¦æƒ•ã€‚\n\n2. **æ— è„¸ä¹˜å®¢çš„å‡ºç°ï¼š**  \n   ä»–ä¼šä¸»åŠ¨é è¿‘ä½ ï¼Œå¹¶ä½å£°è¯¢é—®ï¼šâ€œ**ä½ è¦å»å“ªï¼Ÿ**â€\n\n3. **æ­£ç¡®åº”å¯¹æ–¹å¼ï¼š**  \n   - å¿…é¡»å›ç­”ä¸€ä¸ª**çœŸå®å­˜åœ¨äºä¸Šæµ·çš„åœ°å**ï¼Œä¾‹å¦‚â€œäººæ°‘å¹¿åœºâ€ã€â€œå¾å®¶æ±‡â€ã€â€œé™†å®¶å˜´â€ç­‰ã€‚\n   - å›ç­”è¦æ¸…æ™°ã€å‡†ç¡®ï¼Œä¸èƒ½çŠ¹è±«æˆ–è¯´é”™ã€‚\n\n4. **é”™è¯¯è¡Œä¸ºåŠåæœï¼š**  \n   - è‹¥ä½ å›ç­”ä¸€ä¸ª**ä¸å­˜åœ¨çš„åœ°å**ï¼ˆå¦‚â€œæ–°å®¿â€ã€â€œç‹åºœäº•â€ï¼‰ï¼Œæˆ–**ä¿æŒæ²‰é»˜**ï¼Œä½ å°†ä¼šåœ¨è½¦å¢ä¸­çœ‹åˆ°**è‡ªå·±çš„å°¸ä½“**ã€‚\n   - è¿™æ„å‘³ç€ä½ å°†æ— æ³•é€ƒè„±æ­»äº¡çš„å‘½è¿ã€‚\n\n---\n\n### ğŸ§  å°è´´å£«ï¼š\n\n- å¦‚æœä½ ä¸ç¡®å®šæŸä¸ªåœ°åæ˜¯å¦å±äºä¸Šæµ·ï¼Œå»ºè®®æå‰äº†è§£ä¸€äº›çœŸå®åœ°åä»¥é˜²ä¸‡ä¸€ã€‚\n- è‹¥çœŸçš„é­é‡æ­¤æƒ…æ™¯ï¼Œä¿æŒå†·é™ï¼Œè¿…é€Ÿå›å¿†ä¸€ä¸ªç¡®åˆ‡çš„ä¸Šæµ·åœ°åä½œç­”ã€‚\n- åˆ‡å‹¿è¯•å›¾æ¬ºéª—ã€å¼€ç©ç¬‘æˆ–æ²‰é»˜ä¸è¯­ã€‚\n\n---\n\n**è®°ä½ï¼šè§„åˆ™æ˜¯ç”Ÿå­˜çš„åº•çº¿ï¼Œè¿è€…â€”â€”åæœè‡ªè´Ÿã€‚**\n"}],"key":"a4hMhonE9Z"}],"key":"WF7X0dxxaU"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"ä¸‰ã€åœ¨å·¥å…·ä¸­ä½¿ç”¨ä¸Šä¸‹æ–‡","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"o5pAUU7F8b"}],"identifier":"id","label":"ä¸‰ã€åœ¨å·¥å…·ä¸­ä½¿ç”¨ä¸Šä¸‹æ–‡","html_id":"id-2","implicit":true,"key":"GUEiyDxfCA"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"ä¸‹é¢ï¼Œæˆ‘ä»¬å°è¯•åœ¨å·¥å…·ä¸­ä½¿ç”¨å­˜å‚¨åœ¨ ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FBnpdncgXp"},{"type":"inlineCode","value":"SqliteStore","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qyhqwj15pa"},{"type":"text","value":" ä¸­çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"BV7lfuhZGF"}],"key":"RJTgQrDIEi"}],"key":"JmCeJqjJlw"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# åˆ é™¤SQLiteæ•°æ®åº“\nif os.path.exists(\"user-info.db\"):\n    os.remove(\"user-info.db\")\n\n# åˆ›å»ºSQLiteå­˜å‚¨\nconn = sqlite3.connect(\"user-info.db\", check_same_thread=False, isolation_level=None)\nconn.execute(\"PRAGMA journal_mode=WAL;\")\nconn.execute(\"PRAGMA busy_timeout = 30000;\")\n\nstore = SqliteStore(conn)\n\n# é¢„ç½®ä¸¤æ¡ç”¨æˆ·ä¿¡æ¯\nstore.put((\"user_info\",), \"æŸ³å¦‚çƒŸ\", {\"description\": \"æ¸…å†·æ‰å¥³ï¼Œèº«æ€€ç»æŠ€ï¼Œä¸ºå¯»èº«ä¸–ä¹‹è°œè¸å…¥æ±Ÿæ¹–ã€‚\", \"birthplace\": \"å´å…´å¿\"})\nstore.put((\"user_info\",), \"è‹æ…•ç™½\", {\"description\": \"å­¤å‚²å‰‘å®¢ï¼Œå‰‘æ³•è¶…ç¾¤ï¼ŒèƒŒè´Ÿå®¶æ—è¡€ä»‡ï¼Œéšäºå¸‚äº•è¿½å¯»çœŸç›¸ã€‚\", \"birthplace\": \"æ­å¿\"})","key":"OnPgfI3vUH"},{"type":"output","id":"J2dF5JdavWR8eowOqDAJn","data":[],"key":"z06KmUVk6z"}],"key":"BqvxjKbhLu"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"1ï¼‰åŸºç¡€ç”¨ä¾‹","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JZWMDM6dJB"}],"identifier":"id-1","label":"1ï¼‰åŸºç¡€ç”¨ä¾‹","html_id":"id-1-1","implicit":true,"key":"MZChxYOrQx"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"ä½¿ç”¨ ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"C9DXTH0Dmv"},{"type":"inlineCode","value":"ToolRuntime","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"z0gizMcTh1"}],"key":"O7f40ttHXs"}],"key":"DecnxHtkJV"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"@tool\ndef fetch_user_data(\n    user_id: str,\n    runtime: ToolRuntime\n) -> str:\n    \"\"\"\n    Fetch user information from the in-memory store.\n\n    :param user_id: The unique identifier of the user.\n    :param runtime: The tool runtime context injected by the framework.\n    :return: The user's description string if found; an empty string otherwise.\n    \"\"\"\n    store = runtime.store\n    user_info = store.get((\"user_info\",), user_id)\n\n    user_desc = \"\"\n    if user_info:\n        user_desc = user_info.value.get(\"description\", \"\")\n\n    return user_desc\n\nagent = create_agent(\n    model=llm,\n    tools=[fetch_user_data],\n    store=store,\n)","key":"gK8iPZxrWV"},{"type":"output","id":"UEdL9GVSk-rM-EN_yzP6w","data":[],"key":"rgpa1ohIHh"}],"key":"hvkCOohBvR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"result = agent.invoke({\n    \"messages\": [{\n        \"role\": \"user\",\n        \"content\": \"äº”åˆ†é’Ÿä¹‹å†…ï¼Œæˆ‘è¦æŸ³å¦‚çƒŸçš„å…¨éƒ¨ä¿¡æ¯\"\n    }]\n})\n\nfor message in result['messages']:\n    message.pretty_print()","key":"xQvTy5yvsd"},{"type":"output","id":"oPXZNWX0Kt5cHSNT16Bdc","data":[{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\näº”åˆ†é’Ÿä¹‹å†…ï¼Œæˆ‘è¦æŸ³å¦‚çƒŸçš„å…¨éƒ¨ä¿¡æ¯\n==================================\u001b[1m Ai Message \u001b[0m==================================\nTool Calls:\n  fetch_user_data (call_bb5059c893d74cebac0f7727)\n Call ID: call_bb5059c893d74cebac0f7727\n  Args:\n    user_id: æŸ³å¦‚çƒŸ\n=================================\u001b[1m Tool Message \u001b[0m=================================\nName: fetch_user_data\n\næ¸…å†·æ‰å¥³ï¼Œèº«æ€€ç»æŠ€ï¼Œä¸ºå¯»èº«ä¸–ä¹‹è°œè¸å…¥æ±Ÿæ¹–ã€‚\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\næ ¹æ®æˆ‘ç›®å‰æŒæ¡çš„ä¿¡æ¯ï¼ŒæŸ³å¦‚çƒŸæ˜¯ä¸€ä½æ¸…å†·æ‰å¥³ï¼Œèº«æ€€ç»æŠ€ï¼Œä¸ºäº†æ¢å¯»è‡ªå·±çš„èº«ä¸–ä¹‹è°œè€Œè¸å…¥æ±Ÿæ¹–ã€‚ä¸è¿‡ï¼Œè¿™ä»…ä»…æ˜¯å¥¹çš„ä¸€éƒ¨åˆ†ä¿¡æ¯ï¼Œæ›´å¤šè¯¦ç»†èµ„æ–™å¯èƒ½éœ€è¦è¿›ä¸€æ­¥è°ƒæŸ¥æ‰èƒ½è·å¾—ã€‚ä½ å¯¹å¥¹æœ‰ä»€ä¹ˆç‰¹åˆ«çš„å…´è¶£æˆ–ç›®çš„å—ï¼Ÿæˆ–è®¸æˆ‘å¯ä»¥å¸®ä½ äº†è§£æ›´å¤šã€‚\n"}],"key":"FiFdfj72fH"}],"key":"vYRH8Bs5UX"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2ï¼‰å¤æ‚ä¸€ç‚¹çš„ä¾‹å­","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fngA1fttyM"}],"identifier":"id-2","label":"2ï¼‰å¤æ‚ä¸€ç‚¹çš„ä¾‹å­","html_id":"id-2-1","implicit":true,"key":"jC8qiL8C2a"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"ä½¿ç”¨ ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"N87064a0y1"},{"type":"inlineCode","value":"ToolRuntime[Context]","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"fuXAajOjot"}],"key":"kbv68JNibI"}],"key":"msrnPrCYMC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"@dataclass\nclass Context:\n    key: str\n\n@tool\ndef fetch_user_data(\n    user_id: str,\n    runtime: ToolRuntime[Context]\n) -> str:\n    \"\"\"\n    Fetch user information from the in-memory store.\n\n    :param user_id: The unique identifier of the user.\n    :param runtime: The tool runtime context injected by the framework.\n    :return: The user's description string if found; an empty string otherwise.\n    \"\"\"\n    key = runtime.context.key\n\n    store = runtime.store\n    user_info = store.get((\"user_info\",), user_id)\n\n    user_desc = \"\"\n    if user_info:\n        user_desc = user_info.value.get(key, \"\")\n\n    return f\"{key}: {user_desc}\"\n\nagent = create_agent(\n    model=llm,\n    tools=[fetch_user_data],\n    store=store,\n)","key":"Cc1NPolDU3"},{"type":"output","id":"BjcueBrqAv1njHab6rKhn","data":[],"key":"w3iZSjuEMk"}],"key":"hSWQiJ97G6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"result = agent.invoke(\n    {\"messages\": [{\"role\": \"user\", \"content\": \"äº”åˆ†é’Ÿä¹‹å†…ï¼Œæˆ‘è¦æŸ³å¦‚çƒŸçš„å…¨éƒ¨ä¿¡æ¯\"}]},\n    context=Context(key=\"birthplace\"),\n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"bLuqGicfpf"},{"type":"output","id":"71p1E407tFOw6TpCZXJu_","data":[{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\näº”åˆ†é’Ÿä¹‹å†…ï¼Œæˆ‘è¦æŸ³å¦‚çƒŸçš„å…¨éƒ¨ä¿¡æ¯\n==================================\u001b[1m Ai Message \u001b[0m==================================\nTool Calls:\n  fetch_user_data (call_5373b11fd735425990cc9748)\n Call ID: call_5373b11fd735425990cc9748\n  Args:\n    user_id: æŸ³å¦‚çƒŸ\n=================================\u001b[1m Tool Message \u001b[0m=================================\nName: fetch_user_data\n\nbirthplace: å´å…´å¿\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\næŸ³å¦‚çƒŸçš„åŸºæœ¬ä¿¡æ¯å¦‚ä¸‹ï¼š\n\n- **å‡ºç”Ÿåœ°**ï¼šå´å…´å¿\n\nç”±äºæ—¶é—´é™åˆ¶ï¼Œç›®å‰ä»…è·å–åˆ°ä»¥ä¸Šä¿¡æ¯ã€‚å¦‚éœ€æ›´è¯¦ç»†çš„èµ„æ–™ï¼Œè¯·æä¾›æ›´å¤šçº¿ç´¢æˆ–å»¶é•¿æŸ¥è¯¢æ—¶é—´ã€‚\n"}],"key":"qZAWy64X4N"}],"key":"lef7p117qV"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"å››ã€å‹ç¼©ä¸Šä¸‹æ–‡","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cSQrDkE7f4"}],"identifier":"id","label":"å››ã€å‹ç¼©ä¸Šä¸‹æ–‡","html_id":"id-3","implicit":true,"key":"NxoKDVSZ4I"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"LangChain æä¾›äº†å†…ç½®çš„ä¸­é—´ä»¶ ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"IM3XJyCaV3"},{"type":"inlineCode","value":"SummarizationMiddleware","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FS9YoyxDhi"},{"type":"text","value":" ç”¨äºå‹ç¼©ä¸Šä¸‹æ–‡ã€‚è¯¥ä¸­é—´ä»¶ç»´æŠ¤çš„æ˜¯å…¸å‹çš„ ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"KBAe7VLU11"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"ç”Ÿå‘½å‘¨æœŸä¸Šä¸‹æ–‡","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"nCBMfmgX0x"}],"key":"rlaeUW72UM"},{"type":"text","value":"ï¼Œä¸ ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"OC2VrInwHm"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"æ¨¡å‹ä¸Šä¸‹æ–‡","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"anqcYI5ZJi"}],"key":"M6so9ssn5z"},{"type":"text","value":" å’Œ ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Jc7Mx8sVFZ"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"å·¥å…·ä¸Šä¸‹æ–‡","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"osLqnXvJ2S"}],"key":"b4olcJ7zul"},{"type":"text","value":" çš„ç¬æ€æ›´æ–°ä¸åŒï¼Œç”Ÿå‘½å‘¨æœŸä¸Šä¸‹æ–‡ä¼šæŒç»­æ›´æ–°ï¼šæŒç»­å°†æ—§æ¶ˆæ¯æ›¿æ¢ä¸ºæ‘˜è¦ã€‚","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"eD3lIZijeT"}],"key":"YGMcJgmiPs"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"é™¤éä¸Šä¸‹æ–‡è¶…é•¿ï¼Œå¯¼è‡´æ¨¡å‹èƒ½åŠ›é™ä½ï¼Œå¦åˆ™ä¸éœ€è¦ä½¿ç”¨ ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"JOF3L3802g"},{"type":"inlineCode","value":"SummarizationMiddleware","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"dWZy2kPknC"},{"type":"text","value":"ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè§¦å‘æ‘˜è¦å¾—å€¼å¯ä»¥è®¾å¾—è¾ƒå¤§ã€‚æ¯”å¦‚ï¼š","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"el77SJ3DpY"}],"key":"VYn3RT81gl"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"max_tokens_before_summary","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Vlru5jhGr4"},{"type":"text","value":": 3000","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"cGBQdQ5Gva"}],"key":"TLSAKkte34"}],"key":"VLCVuFllWr"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"messages_to_keep","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"ZcBzUW0kwb"},{"type":"text","value":": 20","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"chw7X6wehY"}],"key":"YsJ1QUHzdc"}],"key":"XbcIzEYcjn"}],"key":"MDwPNJTRsB"},{"type":"blockquote","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"å¦‚æœä½ æƒ³äº†è§£æ›´å¤šå…³äºä¸Šä¸‹æ–‡è…åï¼ˆContext Rotï¼‰çš„ä¿¡æ¯ï¼ŒChroma å›¢é˜Ÿåœ¨ 2025 å¹´ 7 æœˆ 14 æ—¥å‘å¸ƒçš„ ","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"vqJ8hqWM1L"},{"type":"link","url":"https://research.trychroma.com/context-rot","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"emphasis","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"Context Rot: How Increasing Input Tokens Impacts LLM Performance","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"X73a1UpGRb"}],"key":"XsXeGZlfKw"}],"urlSource":"https://research.trychroma.com/context-rot","key":"KgVihUR766"},{"type":"text","value":"ï¼Œç³»ç»Ÿæ€§åœ°æ­ç¤ºäº†é•¿ä¸Šä¸‹æ–‡å¯¼è‡´æ¨¡å‹æ€§èƒ½é€€åŒ–çš„ç°è±¡ã€‚","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"tHtnVHAicK"}],"key":"rtvm2ojx4w"}],"key":"QMZp5Cj0Io"}],"key":"Upi9558INf"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# åˆ›å»ºçŸ­æœŸè®°å¿†\ncheckpointer = InMemorySaver()\n\n# åˆ›å»ºå¸¦å†…ç½®æ‘˜è¦ä¸­é—´ä»¶çš„Agent\n# ä¸ºäº†è®©é…ç½®èƒ½åœ¨æˆ‘ä»¬çš„ä¾‹å­é‡Œç”Ÿæ•ˆï¼Œè¿™é‡Œçš„è§¦å‘å€¼è®¾å¾—å¾ˆå°\nagent = create_agent(\n    model=llm,\n    middleware=[\n        SummarizationMiddleware(\n            model=llm,\n            max_tokens_before_summary=40,  # Trigger summarization at 40 tokens\n            messages_to_keep=1,  # Keep last 1 messages after summary\n        ),\n    ],\n)","key":"HYVLW6FVk8"},{"type":"output","id":"-cDnNum5z4abs58PJ3qWL","data":[],"key":"xar8qsO65K"}],"key":"Ld1TfeUVE0"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"result = agent.invoke(\n    {\"messages\": [\n        {\"role\": \"user\", \"content\": \"å¹¿å·ä»Šå¤©çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ\"},\n        {\"role\": \"assistant\", \"content\": \"å¹¿å·å¤©æ°”å¾ˆå¥½\"},\n        {\"role\": \"user\", \"content\": \"åƒç‚¹ä»€ä¹ˆå¥½å‘¢\"},\n        {\"role\": \"assistant\", \"content\": \"è¦ä¸è¦åƒé¦™èŒ…é³—é±¼ç…²\"},\n        {\"role\": \"user\", \"content\": \"é¦™èŒ…æ˜¯ä»€ä¹ˆ\"},\n        {\"role\": \"assistant\", \"content\": \"é¦™èŒ…åˆåæŸ æª¬è‰ï¼Œå¸¸è§äºæ³°å¼å†¬é˜´åŠŸæ±¤ã€è¶Šå—çƒ¤è‚‰\"},\n        {\"role\": \"user\", \"content\": \"auv é‚£è¿˜ç­‰ä»€ä¹ˆï¼Œå’±åƒå»å§\"},\n    ]},\n    checkpointer=checkpointer,\n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"XpPzKQxmb8"},{"type":"output","id":"r2aje5XjTPhNPYNKgeWSZ","data":[{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nHere is a summary of the conversation to date:\n\nå¹¿å·å¤©æ°”å¾ˆå¥½ï¼›å»ºè®®åƒé¦™èŒ…é³—é±¼ç…²ï¼›é¦™èŒ…åˆåæŸ æª¬è‰ï¼Œå¸¸è§äºæ³°å¼å†¬é˜´åŠŸæ±¤ã€è¶Šå—çƒ¤è‚‰ã€‚\n================================\u001b[1m Human Message \u001b[0m=================================\n\nauv é‚£è¿˜ç­‰ä»€ä¹ˆï¼Œå’±åƒå»å§\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nå“ˆå“ˆï¼Œçœ‹èµ·æ¥ä½ å·²ç»è¿«ä¸åŠå¾…äº†ï¼ğŸ˜„\n\næ—¢ç„¶å¹¿å·å¤©æ°”è¿™ä¹ˆå¥½ï¼Œé¦™èŒ…é³—é±¼ç…²å¬èµ·æ¥ç¡®å®æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ä½ æåˆ°çš„é¦™èŒ…ï¼ˆæŸ æª¬è‰ï¼‰ç¡®å®æ˜¯ä¸œå—äºšæ–™ç†ä¸­çš„ç»å…¸é¦™æ–™ï¼Œèƒ½ä¸ºé³—é±¼å¢æ·»ç‹¬ç‰¹çš„æ¸…é¦™ã€‚\n\nä¸è¿‡æˆ‘å¾—æé†’ä¸€ä¸‹ï¼Œä½œä¸ºAIï¼Œæˆ‘æ— æ³•çœŸæ­£å’Œä½ ä¸€èµ·å»åƒé¥­ã€‚å¦‚æœä½ çœŸçš„è¦å»å“å°è¿™é“èœï¼Œè®°å¾—é€‰æ‹©é£Ÿææ–°é²œã€å£ç¢‘å¥½çš„é¤å…å“¦ï¼\n\nä½ æ˜¯åœ¨å¹¿å·å—ï¼Ÿè¿˜æ˜¯åœ¨å…¶ä»–åœ°æ–¹æƒ³å°è¯•è¿™é“èœï¼Ÿ\n"}],"key":"d3ddE4lWMW"}],"key":"GsaPTwhMqp"}],"key":"EpDwUuER2P"},"references":{"cite":{"order":[],"data":{}}}}