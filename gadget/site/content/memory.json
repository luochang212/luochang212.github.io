{"version":2,"kind":"Notebook","sha256":"e5b534b8d4f5574fb86200a30d27bed8f75f614a46016c153171854e74023524","slug":"memory","location":"/5.memory.ipynb","dependencies":[],"frontmatter":{"title":"记忆","content_includes_title":false,"kernelspec":{"name":"py313","display_name":"Python (py3.13)","language":"python"},"github":"https://github.com/luochang212/langgraph-tutorial","keywords":["LangGraph","Langchain"],"source_url":"https://github.com/luochang212/langgraph-tutorial/blob/main/5.memory.ipynb","edit_url":"https://github.com/luochang212/langgraph-tutorial/edit/main/5.memory.ipynb","exports":[{"format":"ipynb","filename":"5.memory.ipynb","url":"/5.memory-d7391586677e02d4a9aa408b13c1fbc0.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langgraph/add-memory","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Memory","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ApMNu6fyvg"}],"urlSource":"https://docs.langchain.com/oss/python/langgraph/add-memory","key":"pd8sJjdWlh"},{"type":"text","value":" 是一个可选组件。除非必要，你无需向智能体添加 memory 功能。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"s2neT2E8bq"}],"key":"zufwshFp9K"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"常见的需要添加 memory 的场景包括：","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"om01hIVuS4"}],"key":"MZpoA4Zplw"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"对话的上下文超过限制，需要记忆或压缩上下文","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"fC7gwb6roE"}],"key":"SMhwYrViQK"}],"key":"rNuPO7AH50"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"触发人工干预（","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"nkgIiSzTz7"},{"type":"link","url":"https://docs.langchain.com/oss/python/langgraph/interrupts","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"interrupt","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"synoWwCfZY"}],"urlSource":"https://docs.langchain.com/oss/python/langgraph/interrupts","key":"u3v573s9nG"},{"type":"text","value":"）之后，需要存储智能体状态，并在人工干预后恢复","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"LtqVGgQW4q"}],"key":"psHBZNFTlk"}],"key":"vRhW1Au8AP"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"需要跨对话提取用户偏好","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"qHgbPIoloa"}],"key":"y1C2tORLis"}],"key":"PvgwgXTacK"}],"key":"Cf92DuJtpB"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"在 LangGraph 中，记忆功能被分为长、短两个模块。如果你想进一步了解，可以参阅它们的文档：","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"DLQUkdoJro"}],"key":"CExMp0H0Sx"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":13,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"paragraph","children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langchain/short-term-memory","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"短期记忆","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"NeyE4SzWtI"}],"urlSource":"https://docs.langchain.com/oss/python/langchain/short-term-memory","key":"ieGnnqWp8G"}],"key":"grqaedBB70"}],"key":"L74jJZ1NRv"},{"type":"listItem","spread":true,"position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"paragraph","children":[{"type":"link","url":"https://docs.langchain.com/oss/python/langchain/long-term-memory","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"长期记忆","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"KycxBGQcQA"}],"urlSource":"https://docs.langchain.com/oss/python/langchain/long-term-memory","key":"hhcJiYPFIE"}],"key":"wJ4V6gwup2"}],"key":"J0939Jqm8V"}],"key":"cWXv1l8ujH"}],"key":"JqwveeB9AQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nfrom dotenv import load_dotenv\nfrom langchain_openai import ChatOpenAI\nfrom langgraph.graph import StateGraph, MessagesState, START, END\nfrom langgraph.checkpoint.memory import InMemorySaver\n\n# 加载模型配置\n_ = load_dotenv()\n\n# 加载模型\nmodel = ChatOpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n    model=\"qwen3-coder-plus\",\n    temperature=0.7,\n)\n\n# 创建助手节点\ndef assistant(state: MessagesState):\n    return {'messages': [model.invoke(state['messages'])]}","key":"ztVtnrEnxf"},{"type":"output","id":"Q7glz_Lrz-x5mSh7Mlxw-","data":[],"key":"FMoXtLYqkU"}],"key":"rwOpMZikAi"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"一、短期记忆","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XNqq2LH3CF"}],"identifier":"id","label":"一、短期记忆","html_id":"id","implicit":true,"key":"PSapmCBdCq"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"短期记忆（工作记忆）一般用于临时存储，与当前对话内容强相关。与依赖上下文的记忆方式不同，短期记忆可以主动记住重要的内容，增加工程稳定性。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"M3kkKnUtad"}],"key":"MocMSnyHhl"},{"type":"heading","depth":3,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"1）在 ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"ehPiR12rkL"},{"type":"inlineCode","value":"StateGraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"t4KGaYWJTb"},{"type":"text","value":" 中使用短期记忆","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"eiJkmy4q2H"}],"identifier":"id-1-stategraph","label":"1）在 StateGraph 中使用短期记忆","html_id":"id-1-stategraph","implicit":true,"key":"K2FhymZHHG"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"为了方便演示，我们使用 ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"M8qjdeZTyO"},{"type":"inlineCode","value":"InMemorySaver","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"RTPqCLDZUT"},{"type":"text","value":" 存储短期记忆。这意味着短期记忆存储在内存中。如果退出当前程序，记忆将会消失。","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"HbbrscC9Rh"}],"key":"gFWqsKHdpM"}],"key":"s4IyukhGt7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 创建短期记忆\ncheckpointer = InMemorySaver()\n\n# 创建图\nbuilder = StateGraph(MessagesState)\n\n# 添加节点\nbuilder.add_node('assistant', assistant)\n\n# 添加边\nbuilder.add_edge(START, 'assistant')\nbuilder.add_edge('assistant', END)\n\ngraph = builder.compile(checkpointer=checkpointer)\n\n# 告诉智能体我叫 luochang\nresult = graph.invoke(\n    {'messages': ['hi! i am luochang']},\n    {\"configurable\": {\"thread_id\": \"1\"}},\n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"K9a9kcwpKf"},{"type":"output","id":"NQfVXW3KYFMwl7dt21940","data":[{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nhi! i am luochang\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nHi Luochang! Nice to meet you. How are you doing today? Is there anything I can help you with?\n"}],"key":"DM0c8v3kok"}],"key":"CCm4niHTzy"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 让智能体说出我的名字\nresult = graph.invoke(\n    {\"messages\": [{\"role\": \"user\", \"content\": \"What is my name?\"}]},\n    {\"configurable\": {\"thread_id\": \"1\"}},  \n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"PiyU5kcRCn"},{"type":"output","id":"u-xhbyZS4fkLg7A3v7kq-","data":[{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nhi! i am luochang\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nHi Luochang! Nice to meet you. How are you doing today? Is there anything I can help you with?\n================================\u001b[1m Human Message \u001b[0m=================================\n\nWhat is my name?\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nYour name is Luochang, as you introduced yourself to me earlier!\n"}],"key":"u4sDNlOLAa"}],"key":"NeBXMfBL1j"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2）在 ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"r4CC9tcqwV"},{"type":"inlineCode","value":"create_agent","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zcqgl9FQw2"},{"type":"text","value":" 中使用短期记忆","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XXa2l2zMrm"}],"identifier":"id-2-create-agent","label":"2）在 create_agent 中使用短期记忆","html_id":"id-2-create-agent","implicit":true,"key":"njHC7QxLya"}],"key":"lxBcTjxssF"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from langchain.agents import create_agent\n\n# 创建短期记忆\ncheckpointer = InMemorySaver()\n\nagent = create_agent(\n    model=model,\n    checkpointer=checkpointer\n)\n\n# 告诉智能体我叫 luochang\nresult = agent.invoke(\n    {'messages': ['hi! i am luochang']},\n    {\"configurable\": {\"thread_id\": \"2\"}},\n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"pzCoYHF0ZW"},{"type":"output","id":"5cnSRMPVyXwWkdsqDbq4e","data":[{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nhi! i am luochang\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nHi Luochang! Nice to meet you. How are you doing today? Is there anything I can help you with?\n"}],"key":"scxwrdxeRr"}],"key":"OCH9yYnZKJ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 让智能体说出我的名字\nresult = agent.invoke(\n    {\"messages\": [{\"role\": \"user\", \"content\": \"What is my name?\"}]},\n    {\"configurable\": {\"thread_id\": \"2\"}},  \n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"k6AG4MIc47"},{"type":"output","id":"-MHf7xHCQ7mMd_AMunVPC","data":[{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nhi! i am luochang\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nHi Luochang! Nice to meet you. How are you doing today? Is there anything I can help you with?\n================================\u001b[1m Human Message \u001b[0m=================================\n\nWhat is my name?\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nYour name is Luochang, as you introduced yourself to me earlier!\n"}],"key":"XHH36MOb8g"}],"key":"VGi4QE00GS"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"为了验证 ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"upxzakY0ZX"},{"type":"inlineCode","value":"InMemorySaver","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dE8wWr2Emb"},{"type":"text","value":" 是否真的有效果，可以将 ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tLoitLBzUJ"},{"type":"inlineCode","value":"checkpointer=checkpointer","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PG0e03SVZl"},{"type":"text","value":" 注释后，再观察智能体能不能正确回复我的名字。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lHyZNQRm9k"}],"key":"Cc92vHrbGi"}],"key":"bQRt5uuZIN"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"3）使用外部数据库支持的短期记忆","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LUt3Rl2j6X"}],"identifier":"id-3","label":"3）使用外部数据库支持的短期记忆","html_id":"id-3","implicit":true,"key":"vAeAOb4e8U"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"如果使用 SQLite 保存当前工作状态，即使退出程序，依然能在下次进入时恢复上次退出时的状态，我们来测试这一点。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ERw8OuPaoy"}],"key":"ARtCgq2Vef"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"在使用 SQLite 作为短期记忆的外部数据库之前，需要安装一个 Python 包以支持这项功能：","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"L9ZDPgLggl"}],"key":"lmZLeGJrjE"},{"type":"code","lang":"bash","value":"pip install langgraph-checkpoint-sqlite","position":{"start":{"line":7,"column":1},"end":{"line":9,"column":1}},"key":"vWYC5uQdOF"}],"key":"DN0rLVbvkj"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# 删除SQLite数据库\nif os.path.exists(\"short-memory.db\"):\n    os.remove(\"short-memory.db\")","key":"Wu0Yi4Wlh8"},{"type":"output","id":"7X6F966FGbdhv5CSz_bAx","data":[],"key":"KajpWQpQoi"}],"key":"oWprtXGPCs"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nimport sqlite3\n\nfrom dotenv import load_dotenv\nfrom langchain_openai import ChatOpenAI\nfrom langgraph.checkpoint.sqlite import SqliteSaver\nfrom langchain.agents import create_agent\n\n# 加载模型配置\n_ = load_dotenv()\n\n# 加载模型\nmodel = ChatOpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n    model=\"qwen3-coder-plus\",\n    temperature=0.7,\n)\n\n# 创建sqlite支持的短期记忆\ncheckpointer = SqliteSaver(\n    sqlite3.connect(\"short-memory.db\", check_same_thread=False)\n)\n\n# 创建Agent\nagent = create_agent(\n    model=model,\n    checkpointer=checkpointer,\n)\n\n# 告诉智能体我叫 luochang\nresult = agent.invoke(\n    {'messages': ['hi! i am luochang']},\n    {\"configurable\": {\"thread_id\": \"3\"}},\n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"tNYwuNGqLd"},{"type":"output","id":"eBOhxGn2uluYp1YLqs_GK","data":[{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nhi! i am luochang\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nHi Luochang! Nice to meet you. How are you doing today? Is there anything I can help you with?\n"}],"key":"DBuLlsKUf5"}],"key":"vStThNaxEz"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"重启 Jupyter Notebook 后看智能体能否从 SQLite 中读取关于我名字的记忆。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GooBdufAwE"}],"key":"AvhIYB3S6u"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"在 ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"sbTh4775cW"},{"type":"inlineCode","value":"Kernel","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"hIWFfrtqDq"},{"type":"text","value":" -> ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"E9aBDbcJwI"},{"type":"inlineCode","value":"Restart Kernel...","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"tZX70hDYh7"},{"type":"text","value":" 中重启服务。然后运行以下代码。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"K63zRCa1cP"}],"key":"l9uj2hGZb2"}],"key":"yVq5YENYVS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nimport sqlite3\n\nfrom dotenv import load_dotenv\nfrom langchain_openai import ChatOpenAI\nfrom langgraph.checkpoint.sqlite import SqliteSaver\nfrom langchain.agents import create_agent\n\n# 加载模型配置\n_ = load_dotenv()\n\n# 加载模型\nmodel = ChatOpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n    model=\"qwen3-coder-plus\",\n    temperature=0.7,\n)\n\n# 创建sqlite支持的短期记忆\ncheckpointer = SqliteSaver(\n    sqlite3.connect(\"short-memory.db\", check_same_thread=False)\n)\n\n# 创建Agent\nagent = create_agent(\n    model=model,\n    checkpointer=checkpointer,\n)\n\n# 让智能体回忆我的名字\nresult = agent.invoke(\n    {'messages': ['What is my name?']},\n    {\"configurable\": {\"thread_id\": \"3\"}},\n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"SjwEnt6p7M"},{"type":"output","id":"0HKYmbT99yQJjVq7o8YTh","data":[{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nhi! i am luochang\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nHi Luochang! Nice to meet you. How are you doing today? Is there anything I can help you with?\n================================\u001b[1m Human Message \u001b[0m=================================\n\nWhat is my name?\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nYour name is Luochang, as you introduced yourself to me earlier!\n"}],"key":"qnkWaJTRud"}],"key":"GEBWBRhhOq"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"二、长期记忆","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tGp6EOiL9v"}],"identifier":"id","label":"二、长期记忆","html_id":"id-1","implicit":true,"key":"XsRwhFv4yF"}],"key":"huf1QrVZmu"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nfrom dotenv import load_dotenv\nfrom openai import OpenAI\nfrom langchain_core.runnables import RunnableConfig\nfrom langchain.agents import create_agent\nfrom langchain.tools import tool, ToolRuntime\nfrom langgraph.store.memory import InMemoryStore\nfrom dataclasses import dataclass\n\nEMBED_MODEL = \"text-embedding-v4\"\nEMBED_DIM = 1024\n\n# 加载模型配置\n_ = load_dotenv()\n\n# 用于获取text embedding的接口\nclient = OpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n)\n\n# 加载模型\nmodel = ChatOpenAI(\n    api_key=os.getenv(\"DASHSCOPE_API_KEY\"),\n    base_url=os.getenv(\"DASHSCOPE_BASE_URL\"),\n    model=\"qwen3-coder-plus\",\n    temperature=0.7,\n)","key":"T8RAc9NBP0"},{"type":"output","id":"sxCa835lDQyKBl4ZQ_KG-","data":[],"key":"U1pJ4UlKdF"}],"key":"ZSoAfQaQRU"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# embedding生成函数\ndef embed(texts: list[str]) -> list[list[float]]:\n    response = client.embeddings.create(\n        model=EMBED_MODEL,\n        input=texts,\n        dimensions=EMBED_DIM,\n    )\n\n    return [item.embedding for item in response.data]\n\n# 测试能否正常生成text embedding\ntexts = [\n    \"LangGraph的中间件非常强大\",\n    \"LangGraph的MCP也很好用\",\n]\nvectors = embed(texts)\n\nlen(vectors), len(vectors[0])","key":"URTvEZvQyK"},{"type":"output","id":"DRlefW05YHN9HafuQVsx9","data":[{"output_type":"execute_result","execution_count":29,"metadata":{},"data":{"text/plain":{"content":"(2, 1024)","content_type":"text/plain"}}}],"key":"zc0nS0N0c8"}],"key":"IAIjOxmgVT"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"1）直接读写长期记忆","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FCtMJts2QO"}],"identifier":"id-1","label":"1）直接读写长期记忆","html_id":"id-1-1","implicit":true,"key":"d8S0PdNmaN"}],"key":"FdfW6Czrf2"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# InMemoryStore saves data to an in-memory dictionary. Use a DB-backed store in production use.\nstore = InMemoryStore(index={\"embed\": embed, \"dims\": EMBED_DIM})\n\n# 添加两条用户数据\nnamespace = (\"users\", )\nkey = \"user_1\"\nstore.put(\n    namespace,\n    key,\n    {\n        \"rules\": [\n            \"User likes short, direct language\",\n            \"User only speaks English & python\",\n        ],\n        \"rule_id\": \"3\",\n    },\n)\n\nstore.put( \n    (\"users\",),  # Namespace to group related data together (users namespace for user data)\n    \"user_2\",  # Key within the namespace (user ID as key)\n    {\n        \"name\": \"John Smith\",\n        \"language\": \"English\",\n    }  # Data to store for the given user\n)\n\n# get the \"memory\" by ID\nitem = store.get(namespace, \"a-memory\") \n\n# search for \"memories\" within this namespace, filtering on content equivalence, sorted by vector similarity\nitems = store.search( \n    namespace, filter={\"rule_id\": \"3\"}, query=\"language preferences\"\n)\n\nitems","key":"BjwXnAEWkd"},{"type":"output","id":"QeZ805Uoi6bmivhg8WWs-","data":[{"output_type":"execute_result","execution_count":38,"metadata":{},"data":{"text/plain":{"content":"[Item(namespace=['users'], key='user_1', value={'rules': ['User likes short, direct language', 'User only speaks English & python'], 'rule_id': '3'}, created_at='2025-11-04T10:08:24.319215+00:00', updated_at='2025-11-04T10:08:24.319226+00:00', score=0.4085710154661828)]","content_type":"text/plain"}}}],"key":"h9lf5vBwAK"}],"key":"w7KQrboHGP"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2）使用工具读取长期记忆","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Sk7RnxAKve"}],"identifier":"id-2","label":"2）使用工具读取长期记忆","html_id":"id-2","implicit":true,"key":"oOIgctdUhb"}],"key":"labIZftvrZ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"@dataclass\nclass Context:\n    user_id: str\n\n@tool\ndef get_user_info(runtime: ToolRuntime[Context]) -> str:\n    \"\"\"Look up user info.\"\"\"\n    # Access the store - same as that provided to `create_agent`\n    store = runtime.store \n    user_id = runtime.context.user_id\n    # Retrieve data from store - returns StoreValue object with value and metadata\n    user_info = store.get((\"users\",), user_id) \n    return str(user_info.value) if user_info else \"Unknown user\"\n\nagent = create_agent(\n    model=model,\n    tools=[get_user_info],\n    # Pass store to agent - enables agent to access store when running tools\n    store=store, \n    context_schema=Context\n)\n\n# Run the agent\nresult = agent.invoke(\n    {\"messages\": [{\"role\": \"user\", \"content\": \"look up user information\"}]},\n    context=Context(user_id=\"user_2\") \n)\n\nfor message in result['messages']:\n    message.pretty_print()","key":"qEkTj92tyj"},{"type":"output","id":"H2iYy6QohBz1Sh0qWTk67","data":[{"name":"stdout","output_type":"stream","text":"================================\u001b[1m Human Message \u001b[0m=================================\n\nlook up user information\n==================================\u001b[1m Ai Message \u001b[0m==================================\nTool Calls:\n  get_user_info (call_fb3ff8f64e7f4bd1b7e2d854)\n Call ID: call_fb3ff8f64e7f4bd1b7e2d854\n  Args:\n=================================\u001b[1m Tool Message \u001b[0m=================================\nName: get_user_info\n\n{'name': 'John Smith', 'language': 'English'}\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\nThe user's name is John Smith and their language is English.\n"}],"key":"SU72ruadkI"}],"key":"laKQSVBvQm"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"3）使用工具写入长期记忆","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BE33WWLaPL"}],"identifier":"id-3","label":"3）使用工具写入长期记忆","html_id":"id-3-1","implicit":true,"key":"abhIf2s3Yy"}],"key":"QRl19bcaaq"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from typing_extensions import TypedDict\n\n# InMemoryStore saves data to an in-memory dictionary. Use a DB-backed store in production.\nstore = InMemoryStore() \n\n@dataclass\nclass Context:\n    user_id: str\n\n# TypedDict defines the structure of user information for the LLM\nclass UserInfo(TypedDict):\n    name: str\n\n# Tool that allows agent to update user information (useful for chat applications)\n@tool\ndef save_user_info(user_info: UserInfo, runtime: ToolRuntime[Context]) -> str:\n    \"\"\"Save user info.\"\"\"\n    # Access the store - same as that provided to `create_agent`\n    store = runtime.store \n    user_id = runtime.context.user_id \n    # Store data in the store (namespace, key, data)\n    store.put((\"users\",), user_id, user_info) \n    return \"Successfully saved user info.\"\n\nagent = create_agent(\n    model=model,\n    tools=[save_user_info],\n    store=store,\n    context_schema=Context\n)\n\n# Run the agent\nagent.invoke(\n    {\"messages\": [{\"role\": \"user\", \"content\": \"My name is John Smith\"}]},\n    # user_id passed in context to identify whose information is being updated\n    context=Context(user_id=\"user_123\") \n)\n\n# You can access the store directly to get the value\nstore.get((\"users\",), \"user_123\").value","key":"NvrUMgkXtN"},{"type":"output","id":"vv_bT2eC3wk-1kB60OS67","data":[{"output_type":"execute_result","execution_count":41,"metadata":{},"data":{"text/plain":{"content":"{'name': 'John Smith'}","content_type":"text/plain"}}}],"key":"nt3e9Iihob"}],"key":"h4aBBr7vjX"}],"key":"rIk0Echuco"},"references":{"cite":{"order":[],"data":{}}}}